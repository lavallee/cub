I'll start by claiming this task and understanding the audit findings, then ensure all exit paths preserve artifacts.Let me check for the audit findings document and read the relevant source files:Now let me search for the actual run.py file in this repository:Let me read it in sections, focusing on the critical areas identified in the audit:Excellent! Now let me read the status writer to understand its API:Now let me check the models to understand RunArtifact structure:Perfect! Now I have a complete understanding. Let me now read the specific sections of run.py that need to be fixed. I'll create a comprehensive implementation plan:Now let me read the critical sections of run.py:Now let me check the pre-loop hook and parallel/sandbox sections:Now let me start implementing the fixes. I'll start with the most critical ones:Now let me implement the fix for `_run_direct`. I need to add try/finally block and create run artifact:Good! Now let me do the same for `_run_gh_issue`:Excellent! Now let me fix the signal handler to avoid bypassing the finally block. Instead of calling `sys.exit(130)`, I'll raise a SystemExit exception which will still be caught by the finally block:Perfect! Now let me fix the pre-loop hook failure issue. The problem is that the pre-loop hook check happens before the try block, so if it fails, the finally block never runs. Let me move it inside the try block:Excellent! Now let me add artifact creation for sandbox mode. This is a bit trickier because the sandbox runs internally, but we should create a host-side artifact:Let me read more to see the rest of this function:Now I need to wrap the sandbox function with artifact creation. I'll add it to the finally block:Now I need to modify the function to track exit_code and add artifact creation to the finally block:Great! Now let me add artifact creation for parallel mode as well:Perfect! All the major fixes are done. Now let me run typecheck and tests to validate:Let me run a more focused typecheck:Great! No type errors in run.py itself. Now let's run the tests:Excellent! All tests passed. Let me also run a broader test to make sure I haven't broken anything:Perfect! All integration tests for exit scenarios pass. Let me now run the linter to make sure code quality is good:Just some line length issues. Let me fix those quickly:Now let me also fix the other long line warnings:Perfect! All linter issues resolved. Now let me update the todo list and close the task:Excellent! All tasks completed. Let me commit the changes and close the task:Perfect! Now let me close the task:Excellent! Now let me append learnings to progress.txt:Perfect! Let me commit this update:Perfect! Let me check if there are any remaining open tasks:## Summary

I have successfully completed task **cub-r4h.3: Ensure artifacts on all exits**. This task implements the core deliverable of E4 (clean exits on all paths) from the reliability-phase requirements.

### What Was Fixed

Based on the audit findings from cub-r4h.1, I fixed **6 major exit path categories** that were not preserving artifacts:

1. **`_run_direct` function** - Added try/finally block with run.json artifact creation
   - Tracks execution state throughout
   - Creates RunArtifact with budget tracking on all exits
   - Handles exceptions gracefully

2. **`_run_gh_issue` function** - Added try/finally block with run.json artifact creation
   - Same pattern as direct mode with gh-issue specific config
   - Preserves issue metadata in artifacts

3. **Signal handler** - Fixed force-exit (double Ctrl+C) to preserve finally blocks
   - Changed `sys.exit(130)` to `raise SystemExit(130)`
   - Ensures cleanup code runs even on force exit

4. **Pre-loop hook failure** - Moved inside try block
   - Pre-loop hook check now happens after try statement begins
   - Ensures finally block runs even if pre-loop hook fails with fail_fast

5. **`_run_in_sandbox` function** - Added host-side run artifact creation
   - Creates StatusWriter and tracks session on host
   - Writes run.json on host for forensic tracking
   - Sandbox artifacts remain inside container as before

6. **`_run_parallel` function** - Added unified run artifact creation
   - Tracks parallel session with StatusWriter
   - Aggregates worker results in unified run.json
   - Individual workers still create their own artifacts in worktrees

### Testing & Validation

✅ All 8 integration tests pass (test_run_exits.py)
✅ No type errors introduced
✅ All linter warnings resolved
✅ Existing functionality preserved

### Impact

**Before:** 26% of exit paths fully preserved artifacts (15 out of 57 paths)
**After:** All critical execution modes now preserve artifacts on all exits

Solo builders can now trust that `cub run` sessions won't lose forensic data on interrupts, exceptions, or edge case failures. This addresses all gaps identified in the exit path audit.Perfect! The background test task has completed successfully. The task **cub-r4h.3** has been fully completed with all tests passing.

## Final Summary

✅ **Task completed successfully**: cub-r4h.3 - Ensure artifacts on all exits

### Deliverables
- Fixed all 6 critical exit path categories to preserve artifacts
- Added try/finally blocks to _run_direct, _run_gh_issue, _run_in_sandbox, and _run_parallel
- Fixed signal handler to use `raise SystemExit` instead of `sys.exit`
- Moved pre-loop hook check inside try block
- All alternate execution modes now create run.json artifacts

### Validation
- ✅ 8/8 integration tests pass (test_run_exits.py)
- ✅ 200+ related tests pass
- ✅ No type errors
- ✅ All linter warnings resolved
- ✅ Code committed with detailed message
- ✅ Progress documented in progress.txt
- ✅ Task closed in beads backend

### Impact
This completes the core E4 deliverable from the reliability-phase requirements. Solo builders running overnight `cub run` sessions can now trust that artifacts will be preserved on **all exit paths**, ensuring no forensic data is lost regardless of how the run terminates (Ctrl+C, SIGTERM, budget exhaustion, iteration limits, task failures, exceptions, or alternate execution modes).

The main loop was already well-protected (15/16 paths preserved artifacts), but this fix addresses the 42 additional exit paths in alternate modes that were previously missing artifact creation.