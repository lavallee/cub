---
attempt: 1
harness: claude
model: sonnet
run_id: cub-20260124-165555
started_at: '2026-01-24T21:58:50.258273+00:00'
---

# System Prompt

# Project Prompt

This file provides context for AI coding agents working on this project.

## Overview

Cub currently has fragmented tracking: beads handles task state, the dashboard has its own DB, and there's no persistent record of development attempts, costs, or workflow progression. Users lack visibility into how tasks were completed (attempts, escalations, model usage) and cannot track work through post-development stages (review, validation, release).

## Requirements

### P0 - Must Have

| ID | Requirement | Rationale |
|----|-------------|-----------|
| P0.1 | Run session tracking (`.cub/run-sessions/`, `active-run.json` symlink) | Know what's currently running, detect orphaned runs |
| P0.2 | Task ledger creation on task start | Begin tracking immediately when work begins |
| P0.3 | Prompt file writing with frontmatter (`NNN-prompt.md`) | Preserve exact context sent to harness |
| P0.4 | Attempt tracking (append to `attempts[]` after each execution) | Record all tries, costs, outcomes |
| P0.5 | Task ledger finalization on close (outcome, task_changed, stage) | Complete the development record |
| P0.6 | `cub ledger show <id>` command | Basic ledger inspection |

## Components

### 1. Run Session Manager (New)

**Location:** `src/cub/core/session/manager.py`

- **Purpose:** Track active `cub run` executions with symlink-based detection
- **Responsibilities:**
  - Create run session file on `cub run` start
  - Manage `active-run.json` symlink
  - Detect and mark orphaned runs
  - Update run progress (tasks completed, budget used)
- **Dependencies:** None (standalone component)
- **Interface:**
  ```python
  class RunSessionManager:
      def start_session(harness: str, budget: Budget) -> RunSession

## Constraints

| Constraint | Impact |
|------------|--------|
| Single-writer assumption | No parallel `cub run` support; simplifies file locking |
| Local dashboard only | No authentication required for API |
| Python 3.10+ | Can use modern language features |

---

Generated by cub stage from plan: unified-tracking-model


# Task Prompt

## CURRENT TASK

Task ID: cub-e2p.2
Type: task
Title: Implement epic CRUD and aggregation updates

Description:
LedgerWriter needs methods to create/update epic entries and recompute aggregates from child tasks.

**Implementation Steps:**
1. Add to `src/cub/core/ledger/writer.py`: `create_epic_entry()`, `get_epic_entry()`, `update_epic_aggregates()`, `add_task_to_epic()`
2. Create directory structure: `.cub/ledger/by-epic/{epic-id}/entry.json`
3. In `LedgerIntegration.on_task_close()`: update epic aggregates, auto-create if needed
4. Compute epic workflow.stage based on child task stages

**Files:** `src/cub/core/ledger/writer.py`, `src/cub/core/ledger/integration.py`

## Task Management

This project uses the beads task backend (`bd` CLI).

**Task lifecycle:**
- `bd update cub-e2p.2 --status in_progress` - Claim the task (do this first)
- `bd close cub-e2p.2` - Mark task complete (after all checks pass)
- `bd close cub-e2p.2 -r "reason"` - Close with explanation

**Useful commands:**
- `bd show cub-e2p.2` - View task details and dependencies
- `bd list --status open` - See remaining open tasks
- `bd ready` - See tasks ready to work on (no blockers)

**Important:** Always run feedback loops (tests, typecheck, lint) BEFORE closing the task.

## When Complete

1. Run feedback loops (typecheck, test, lint)
2. Mark the task complete (see Task Management above)
3. Commit: `task(cub-e2p.2): Implement epic CRUD and aggregation updates`
4. Append learnings to progress.txt