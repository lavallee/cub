I'll start by understanding the current state of the codebase and then implement the backend detection updates and comparison script.Let me find the correct paths:Let me search for config-related code and check if there's existing configuration handling:Now let me check if there's already a configuration file format defined and search for any existing tests:Now I understand the codebase structure. Let me implement the task:

1. Update `detect_backend()` to check for a "both" mode configuration
2. Create a comparison script
3. Write tests

Let me start by updating the backend detection logic and adding a backend mode configuration:Now update the config __init__ to export BackendConfig:Now update the backend.py detect_backend function to check the config:Now I need to update the `get_backend` function to instantiate BothBackend when mode is "both":Now let's create the comparison script:Make the script executable:Now let's create comprehensive tests for the both mode detection:Now let's run the tests to validate our implementation:I see two issues:

1. The config cache is interfering with the test
2. The monkeypatch is not working correctly because we import BeadsBackend inside the function

Let me fix these issues:Now fix the monkeypatch tests to use a different approach:Run the tests again:Perfect! All tests pass. Now let's run the full test suite to make sure we haven't broken anything:The tests are failing because they expect "json" but we changed it to "jsonl". Let me update these tests:Now let me fix the test_get_backend_by_name test which is expecting project_dir to not be passed:I see - the TestBackend class needs an `__init__` that accepts project_dir. Let me fix this:Now run the tests again:Perfect! All tests pass. Let's also run our new tests to make sure they all pass:Excellent! All tests pass. Now let's run type checking and linting:I need to fix the type issue. The protocol doesn't specify project_dir, but we're passing it to the backend. Let me adjust:Great! Now let's run linting:Let me fix these linting issues:Now let me fix the remaining line length issues:Perfect! All checks pass. Now let's commit our changes:Now let me append learnings to progress.txt:Perfect! Now let's commit this progress update:Excellent! Let me verify the implementation is complete by checking if there are any remaining tasks:Perfect! The task cub-j1b.4 is now complete. Let me create a summary of what was accomplished:

## Summary

I've successfully completed task **cub-j1b.4: Update backend detection and add comparison script**. Here's what was implemented:

### ✅ Backend Detection Updates

1. **Added BackendConfig to CubConfig**:
   - New `BackendConfig` model with `mode` field supporting "auto", "beads", "jsonl", and "both"
   - Configuration can be set in `.cub.json` or via `CUB_BACKEND` environment variable

2. **Enhanced `detect_backend()` function**:
   - Updated detection priority: env var → config file → directory detection → default
   - Added logic to check for `backend.mode` in `.cub.json`
   - Validates both backends are available before enabling "both" mode
   - Graceful fallback if requested mode isn't available

3. **Updated `get_backend()` function**:
   - Special handling for "both" mode to instantiate `BothBackend` wrapper
   - Passes `project_dir` to backend constructors for proper initialization

### ✅ Comparison Script

Created `scripts/compare-backends.py` with:
- Standalone script for manual backend validation
- Loads both beads and JSONL backends
- Runs `compare_all_tasks()` to identify divergences
- Pretty-printed output with color coding using Rich library
- Clear exit codes:
  - 0: Backends in sync
  - 1: Divergences detected
  - 2: Error loading backends

### ✅ Comprehensive Testing

Added `tests/test_both_backend.py` with 16 tests covering:
- Environment variable detection (`CUB_BACKEND=both`)
- Config file detection (`backend.mode` in `.cub.json`)
- Fallback behavior when backends are missing
- `BothBackend` instantiation and comparison logic
- Divergence logging and counting

Also updated existing tests to use "jsonl" instead of "json".

### ✅ Quality Checks

- ✅ All 127 tests pass
- ✅ Type checking clean (mypy)
- ✅ Linting clean (ruff)
- ✅ Task closed in beads backend
- ✅ Changes committed with descriptive messages
- ✅ Progress documented in @progress.txt

The implementation is complete and ready for use!