{
  "version": 1,
  "id": "cub-b1a.3",
  "title": "Extract loop state machine to core/run/loop.py",
  "lineage": {
    "spec_file": null,
    "plan_file": null,
    "epic_id": "cub-b1a"
  },
  "task": {
    "title": "Extract loop state machine to core/run/loop.py",
    "description": "The run loop state machine (pick task \u2192 execute \u2192 record \u2192 next) is the core of cub. Extracting it cleanly is the hardest part of this phase \u2014 it touches task selection, harness invocation, result recording, and error handling.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/loop.py` with `RunLoop` class\n2. Define `RunConfig` model (all loop configuration: once, epic, harness, etc.)\n3. Define `RunEvent` enum/model for loop events (task_start, task_end, budget_update, error, complete)\n4. Implement `execute()` as a generator that yields `RunEvent` objects\n5. Move task selection, harness invocation coordination, and result recording into `RunLoop`\n6. Keep signal handling and Rich rendering in `cli/run.py`\n7. `cli/run.py` becomes: parse args \u2192 create `RunConfig` \u2192 iterate `RunLoop.execute()` \u2192 render events\n\n**Files:** src/cub/core/run/loop.py, src/cub/core/run/models.py, src/cub/cli/run.py, tests/test_run_loop.py",
    "type": "task",
    "priority": 0,
    "labels": [
      "complexity:high",
      "core",
      "epic:cub-b1a",
      "model:opus",
      "phase-1",
      "refactor",
      "risk:high"
    ],
    "created_at": "2026-01-28T17:54:44.409206Z",
    "captured_at": "2026-01-28T18:09:27.428870Z"
  },
  "task_changed": null,
  "attempts": [
    {
      "attempt_number": 1,
      "run_id": "cub-20260128-175601",
      "started_at": "2026-01-28T18:09:27.441897",
      "completed_at": "2026-01-28T18:39:27.778805Z",
      "harness": "claude",
      "model": "opus",
      "success": false,
      "error_category": "circuit_breaker_timeout",
      "error_summary": "Circuit breaker tripped: No activity for 30 minutes. The harness appears to be hung or unresponsive.",
      "tokens": {
        "input_tokens": 0,
        "output_tokens": 0,
        "cache_read_tokens": 0,
        "cache_creation_tokens": 0
      },
      "cost_usd": 0.0,
      "duration_seconds": 0
    }
  ],
  "outcome": null,
  "drift": {
    "additions": [],
    "omissions": [],
    "severity": "none"
  },
  "verification": {
    "status": "pending",
    "checked_at": null,
    "tests_passed": null,
    "typecheck_passed": null,
    "lint_passed": null,
    "notes": []
  },
  "workflow": {
    "stage": "dev_complete",
    "stage_updated_at": "2026-01-28T18:09:27.428870Z"
  },
  "state_history": [
    {
      "stage": "dev_complete",
      "at": "2026-01-28T18:09:27.428870Z",
      "by": "cub-run",
      "reason": "Task execution started"
    }
  ],
  "started_at": "2026-01-28T18:09:27.428870Z",
  "completed_at": "2026-01-28T18:09:27.428870Z",
  "tokens": {
    "input_tokens": 0,
    "output_tokens": 0,
    "cache_read_tokens": 0,
    "cache_creation_tokens": 0
  },
  "cost_usd": 0.0,
  "duration_seconds": 0,
  "iterations": 1,
  "approach": "",
  "decisions": [],
  "lessons_learned": [],
  "files_changed": [],
  "commits": [],
  "spec_file": null,
  "run_log_path": "/home/lavallee/clawdbot/cub/.cub/ledger/by-task/cub-b1a.3",
  "epic_id": "cub-b1a",
  "verification_status": "pending",
  "verification_notes": [],
  "harness_name": "claude",
  "harness_model": "opus",
  "workflow_stage": null,
  "workflow_stage_updated_at": null
}