{
  "version": 1,
  "id": "cub-r1b.4",
  "title": "Update cub init and cub update for new context stack",
  "lineage": {
    "spec_file": null,
    "plan_file": null,
    "epic_id": "cub-r1b"
  },
  "task": {
    "title": "Update cub init and cub update for new context stack",
    "description": "The init and update commands need to use the new upsert engine\ninstead of writing full files. Init creates the initial context stack (managed\nsections + constitution + runloop). Update refreshes the managed sections and\nregenerates the map (map wiring comes in Phase 3, but the update command\nstructure needs to be ready).\n\n**Implementation Steps:**\n1. Modify `init_cmd.py`: replace direct file writes with `upsert_managed_section()` calls for AGENTS.md and CLAUDE.md\n2. Add `ensure_constitution()` call to init flow\n3. Add runloop copy to init flow: copy `templates/runloop.md` to `.cub/runloop.md` if not present\n4. Modify `update.py`: add managed section refresh (find existing markers, replace content, bump version if template changed)\n5. Add constitution check to update (ensure exists, don't overwrite)\n6. Add runloop refresh to update (copy if missing, warn if modified from template)\n7. Update `generate_system_prompt()` in run.py to look for `.cub/runloop.md` before `PROMPT.md` (new lookup order: `.cub/runloop.md` \u2192 `PROMPT.md` \u2192 `templates/PROMPT.md` \u2192 `templates/runloop.md` \u2192 fallback)\n8. Update tests for init and update commands\n\n**Files:** src/cub/cli/init_cmd.py, src/cub/cli/update.py, src/cub/cli/run.py, tests/test_init.py",
    "type": "task",
    "priority": 0,
    "labels": [
      "complexity:medium",
      "core",
      "epic:cub-r1b",
      "model:sonnet",
      "phase-2"
    ],
    "created_at": "2026-01-28T03:34:52.365058Z",
    "captured_at": "2026-01-28T04:39:01.508276Z"
  },
  "task_changed": null,
  "attempts": [],
  "outcome": null,
  "drift": {
    "additions": [],
    "omissions": [],
    "severity": "none"
  },
  "verification": {
    "status": "pending",
    "checked_at": null,
    "tests_passed": null,
    "typecheck_passed": null,
    "lint_passed": null,
    "notes": []
  },
  "workflow": {
    "stage": "dev_complete",
    "stage_updated_at": "2026-01-28T04:39:01.508276Z"
  },
  "state_history": [
    {
      "stage": "dev_complete",
      "at": "2026-01-28T04:39:01.508276Z",
      "by": "cub-run",
      "reason": "Task execution started"
    }
  ],
  "started_at": "2026-01-28T04:39:01.508276Z",
  "completed_at": "2026-01-28T04:39:01.508276Z",
  "tokens": {
    "input_tokens": 0,
    "output_tokens": 0,
    "cache_read_tokens": 0,
    "cache_creation_tokens": 0
  },
  "cost_usd": 0.0,
  "duration_seconds": 0,
  "iterations": 1,
  "approach": "",
  "decisions": [],
  "lessons_learned": [],
  "files_changed": [],
  "commits": [],
  "spec_file": null,
  "run_log_path": "/home/lavallee/clawdbot/cub/.cub/ledger/by-task/cub-r1b.4",
  "epic_id": "cub-r1b",
  "verification_status": "pending",
  "verification_notes": [],
  "harness_name": "",
  "harness_model": "",
  "workflow_stage": null,
  "workflow_stage_updated_at": null
}