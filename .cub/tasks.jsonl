{"id": "cub-b1a", "title": "bare-cub #1: Core Run Extraction", "status": "closed", "priority": "P0", "issue_type": "epic", "description": "Extract ~2500 lines of business logic from `cli/run.py` into a new `core/run/` package. This is the highest-risk, highest-impact phase — it establishes the pattern that every subsequent phase follows. All existing tests must continue passing after each extraction step.", "assignee": null, "labels": ["phase-1", "core", "refactor", "risk:high"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.407838", "updated_at": "2026-01-28T18:57:22.732005", "closed_at": "2026-01-28T18:57:22.732002", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T18:57:22.732007] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1b", "title": "bare-cub #2: Rich Boundary Cleanup", "status": "closed", "priority": "P1", "issue_type": "epic", "description": "Remove all Rich imports from `cub.core` modules. Core returns structured data; CLI renders it. This establishes the architectural rule that enables non-CLI interfaces.", "assignee": null, "labels": ["phase-2", "core", "refactor", "cleanup"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.407983", "updated_at": "2026-01-28T19:20:21.672421", "closed_at": "2026-01-28T19:20:21.672417", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T19:20:21.672422] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1c", "title": "bare-cub #3: Service Layer", "status": "closed", "priority": "P1", "issue_type": "epic", "description": "Introduce `cub.core.services` as the public API surface. Services are thin orchestrators that compose domain operations. CLI modules are refactored to call services.", "assignee": null, "labels": ["phase-3", "core", "architecture"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.408044", "updated_at": "2026-01-28T19:59:09.455587", "closed_at": "2026-01-28T19:59:09.455581", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T19:59:09.455589] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1d", "title": "bare-cub #4: Suggestion Engine", "status": "closed", "priority": "P1", "issue_type": "epic", "description": "Build the smart recommendation system that analyzes project state and produces ranked, opinionated suggestions for what to do next.", "assignee": null, "labels": ["phase-4", "core", "feature"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.408089", "updated_at": "2026-01-28T20:22:42.124609", "closed_at": "2026-01-28T20:22:42.124605", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T20:22:42.124610] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1e", "title": "bare-cub #5: Bare Cub Command", "status": "closed", "priority": "P0", "issue_type": "epic", "description": "Implement the default command handler — the user-facing deliverable. When someone types `cub` with no subcommand, it launches the default harness with an opinionated welcome.", "assignee": null, "labels": ["phase-5", "cli", "feature"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.408186", "updated_at": "2026-01-28T20:46:13.750875", "closed_at": "2026-01-28T20:46:13.750871", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T20:46:13.750876] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1f", "title": "bare-cub #6: Skill Discovery & Documentation", "status": "closed", "priority": "P2", "issue_type": "epic", "description": "Make cub capabilities discoverable from within a harness session and document the new architecture.", "assignee": null, "labels": ["phase-6", "docs", "feature"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-28T17:54:44.408236", "updated_at": "2026-01-28T21:05:14.566952", "closed_at": "2026-01-28T21:05:14.566948", "acceptanceCriteria": [], "notes": "[Closed: 2026-01-28T21:05:14.566953] All tasks completed", "complexity_label": null, "model_label": null, "is_ready": false, "priority_numeric": 2}
{"id": "cub-b1a.1", "title": "Create core/run package with prompt builder extraction", "status": "closed", "priority": "P0", "issue_type": "task", "description": "The prompt builder (system prompt generation, task context injection, AGENT.md reading) is the most self-contained piece of `cli/run.py` and the safest to extract first. It establishes the `core/run/` package structure.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/__init__.py` package\n2. Create `src/cub/core/run/prompt_builder.py` — extract `generate_system_prompt()`, `_build_task_context()`, `_read_agent_md()`, and related functions from `cli/run.py`\n3. Define `PromptConfig` and `TaskPrompt` data models for inputs/outputs\n4. Update `cli/run.py` to import from `core/run/prompt_builder` instead of using local functions\n5. Ensure all existing run tests pass unchanged\n6. Add unit tests for prompt builder in isolation\n\n**Files:** src/cub/core/run/__init__.py, src/cub/core/run/prompt_builder.py, src/cub/cli/run.py, tests/test_run_prompt_builder.py", "assignee": "cub-20260128-175601", "labels": ["phase-1", "core", "refactor", "model:opus", "complexity:high", "blocking"], "dependsOn": [], "blocks": ["cub-b1a.2", "cub-b1a.3", "cub-b1a.4", "cub-b1a.5"], "parent": "cub-b1a", "created_at": "2026-01-28T17:54:46.169146", "updated_at": "2026-01-28T18:04:02.242112", "closed_at": "2026-01-28T18:04:02.242086", "acceptanceCriteria": ["`core/run/prompt_builder.py` exists with all prompt generation logic", "`cli/run.py` calls prompt builder from core, no local prompt logic remains", "`pytest tests/` passes with no regressions", "`mypy src/cub` passes clean", "No Rich imports in `core/run/`"], "notes": "[Closed: 2026-01-28T18:04:02.242114] Completed by autonomous execution", "complexity_label": "high", "model_label": "opus", "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1a.2", "title": "Extract budget tracking to core/run/budget.py", "status": "closed", "priority": "P0", "issue_type": "task", "description": "Budget tracking (token counting, cost accounting, limit enforcement) is business logic embedded in the run loop. It needs to be accessible to any interface that runs tasks.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/budget.py` with `BudgetManager` class\n2. Extract token tracking, cost accumulation, and limit checking from `cli/run.py`\n3. Define `BudgetConfig` (limits) and `BudgetState` (current usage) models\n4. Add `check_limit()` method that returns whether to continue or stop\n5. Update `cli/run.py` to use `BudgetManager` instead of inline tracking\n6. Write tests for budget limit enforcement\n\n**Files:** src/cub/core/run/budget.py, src/cub/cli/run.py, tests/test_run_budget.py", "assignee": "cub-20260128-175601", "labels": ["phase-1", "core", "refactor", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1a", "created_at": "2026-01-28T17:54:46.169250", "updated_at": "2026-01-28T18:09:17.082589", "closed_at": "2026-01-28T18:09:17.082585", "acceptanceCriteria": ["`BudgetManager` handles all token/cost tracking", "Budget limits trigger clean stops with clear reasons", "`cli/run.py` has no inline budget math", "Tests cover: under budget, at budget, over budget, no budget set"], "notes": "[Closed: 2026-01-28T18:09:17.082592] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1a.3", "title": "Extract loop state machine to core/run/loop.py", "status": "closed", "priority": "P0", "issue_type": "task", "description": "The run loop state machine (pick task → execute → record → next) is the core of cub. Extracting it cleanly is the hardest part of this phase — it touches task selection, harness invocation, result recording, and error handling.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/loop.py` with `RunLoop` class\n2. Define `RunConfig` model (all loop configuration: once, epic, harness, etc.)\n3. Define `RunEvent` enum/model for loop events (task_start, task_end, budget_update, error, complete)\n4. Implement `execute()` as a generator that yields `RunEvent` objects\n5. Move task selection, harness invocation coordination, and result recording into `RunLoop`\n6. Keep signal handling and Rich rendering in `cli/run.py`\n7. `cli/run.py` becomes: parse args → create `RunConfig` → iterate `RunLoop.execute()` → render events\n\n**Files:** src/cub/core/run/loop.py, src/cub/core/run/models.py, src/cub/cli/run.py, tests/test_run_loop.py", "assignee": "cub-20260128-183943", "labels": ["phase-1", "core", "refactor", "model:opus", "complexity:high", "risk:high"], "dependsOn": [], "blocks": [], "parent": "cub-b1a", "created_at": "2026-01-28T17:54:46.169288", "updated_at": "2026-01-28T18:41:42.743657", "closed_at": "2026-01-28T18:41:42.743618", "acceptanceCriteria": ["`RunLoop.execute()` yields `RunEvent` stream, no print/console output", "`cli/run.py` reduced to <500 lines (arg parsing + event rendering)", "`cub run --once` works end-to-end through the new architecture", "`cub run` (multi-task) works end-to-end", "All existing run tests pass", "`mypy` passes clean"], "notes": "[Closed: 2026-01-28T18:41:42.743661] Completed by autonomous execution", "complexity_label": "high", "model_label": "opus", "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1a.4", "title": "Extract interrupt handling to core/run/interrupt.py", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Signal handling (SIGINT/SIGTERM) for clean shutdown needs to work regardless of which interface is driving the run loop. The interrupt handler should coordinate with the loop state machine.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/interrupt.py` with `InterruptHandler` class\n2. Extract signal registration and `_interrupted` flag logic from `cli/run.py`\n3. Implement cooperative interruption: handler sets flag, loop checks flag between tasks\n4. Add `on_interrupt` callback for cleanup (artifact finalization, ledger entry)\n5. Update `RunLoop` to check interrupt state between iterations\n\n**Files:** src/cub/core/run/interrupt.py, src/cub/core/run/loop.py, src/cub/cli/run.py, tests/test_run_interrupt.py", "assignee": "cub-20260128-183943", "labels": ["phase-1", "core", "refactor", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1a", "created_at": "2026-01-28T17:54:46.169329", "updated_at": "2026-01-28T18:47:30.640522", "closed_at": "2026-01-28T18:47:30.640516", "acceptanceCriteria": ["`InterruptHandler` manages SIGINT/SIGTERM registration", "Interrupts cause clean shutdown between tasks (not mid-task)", "Artifacts and ledger entries are finalized on interrupt", "Works when called from CLI or programmatically"], "notes": "[Closed: 2026-01-28T18:47:30.640526] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1a.5", "title": "Extract git operations to core/run/git_ops.py", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Branch creation, commit tracking, and other git operations during `cub run` are business logic that should be accessible from any interface.\n\n**Implementation Steps:**\n1. Create `src/cub/core/run/git_ops.py` with run-specific git functions\n2. Extract `_create_branch_from_base()`, `_get_gh_issue_title()`, `_get_epic_title()` from `cli/run.py`\n3. Define clear interfaces: `create_run_branch(config) -> str`, `get_epic_context(epic_id) -> EpicContext`\n4. Update `RunLoop` to call git_ops functions instead of inline logic\n5. Write tests with mocked git operations\n\n**Files:** src/cub/core/run/git_ops.py, src/cub/cli/run.py, tests/test_run_git_ops.py", "assignee": "cub-20260128-183943", "labels": ["phase-1", "core", "refactor", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1a", "created_at": "2026-01-28T17:54:46.169369", "updated_at": "2026-01-28T18:57:10.834668", "closed_at": "2026-01-28T18:57:10.834664", "acceptanceCriteria": ["All git operations during run extracted to `core/run/git_ops.py`", "No git subprocess calls remain in `cli/run.py`", "Branch naming convention preserved", "Tests cover branch creation, epic title resolution"], "notes": "[Closed: 2026-01-28T18:57:10.834670] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1b.1", "title": "Move review reporter rendering to CLI layer", "status": "closed", "priority": "P1", "issue_type": "task", "description": "`core/review/reporter.py` is the heaviest Rich violator — it's ~90% Rich rendering. The data models already exist in `core/review/models.py`. We need to split data preparation from rendering.\n\n**Implementation Steps:**\n1. Audit `core/review/reporter.py` to identify data preparation vs rendering\n2. Keep any data transformation logic in core; move to `core/review/formatter.py` if needed (returns structured data)\n3. Create `cli/review/display.py` with all Rich rendering (Panel, Table, Text)\n4. Update `cli/review.py` to call display functions instead of core reporter\n5. Remove Rich imports from `core/review/reporter.py` (or delete if fully moved)\n6. Update tests to verify data output, not rendered output\n\n**Files:** src/cub/core/review/reporter.py, src/cub/cli/review/display.py, src/cub/cli/review.py", "assignee": "cub-20260128-185726", "labels": ["phase-2", "core", "cleanup", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-b1b.5"], "parent": "cub-b1b", "created_at": "2026-01-28T17:54:46.169408", "updated_at": "2026-01-28T19:02:20.690087", "closed_at": "2026-01-28T19:02:20.690062", "acceptanceCriteria": ["Zero Rich imports in `core/review/`", "`cli/review/display.py` handles all review rendering", "`cub review` command output unchanged from user's perspective", "Tests pass"], "notes": "[Closed: 2026-01-28T19:02:20.690089] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1b.2", "title": "Remove Rich from core/pr/service.py and core/worktree/parallel.py", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Both modules use Rich Console for progress/status output. They should emit events or return data, letting the CLI layer handle display.\n\n**Implementation Steps:**\n1. In `core/pr/service.py`: replace `Console` usage with return values or Python logging\n2. In `core/worktree/parallel.py`: replace progress output with callback/event pattern\n3. Define callback protocols: `on_worker_start(task_id)`, `on_worker_complete(task_id, result)`\n4. Update `cli/pr.py` and `cli/worktree.py` to provide Rich-based callbacks\n5. Verify all PR and worktree commands work unchanged\n\n**Files:** src/cub/core/pr/service.py, src/cub/core/worktree/parallel.py, src/cub/cli/pr.py, src/cub/cli/worktree.py", "assignee": "cub-20260128-185726", "labels": ["phase-2", "core", "cleanup", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-b1b.5"], "parent": "cub-b1b", "created_at": "2026-01-28T17:54:46.169430", "updated_at": "2026-01-28T19:12:49.833208", "closed_at": "2026-01-28T19:12:49.833201", "acceptanceCriteria": ["Zero Rich imports in `core/pr/` and `core/worktree/`", "PR and worktree commands produce identical output", "Core modules use callbacks or return data for progress"], "notes": "[Closed: 2026-01-28T19:12:49.833211] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1b.3", "title": "Move bash_delegate to CLI layer", "status": "closed", "priority": "P1", "issue_type": "task", "description": "`core/bash_delegate.py` imports Rich Console and calls `sys.exit()`. It's purely a CLI concern — delegating commands to the bash version of cub.\n\n**Implementation Steps:**\n1. Move `core/bash_delegate.py` to `cli/delegated/runner.py`\n2. Update imports in `cli/delegated.py` and `cli/__init__.py`\n3. Remove `core/bash_delegate.py`\n4. Verify delegated commands (prep, branch, etc.) still work\n\n**Files:** src/cub/core/bash_delegate.py, src/cub/cli/delegated/runner.py, src/cub/cli/delegated.py", "assignee": "cub-20260128-185726", "labels": ["phase-2", "core", "cleanup", "model:sonnet", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-b1b", "created_at": "2026-01-28T17:54:46.169447", "updated_at": "2026-01-28T19:16:59.892654", "closed_at": "2026-01-28T19:16:59.892650", "acceptanceCriteria": ["`core/bash_delegate.py` no longer exists", "Delegated commands work unchanged", "No Rich or sys.exit in any `core/` module"], "notes": "[Closed: 2026-01-28T19:16:59.892655] Completed by autonomous execution", "complexity_label": "low", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1b.4", "title": "Replace Rich logging in core/harness/hooks.py", "status": "closed", "priority": "P1", "issue_type": "task", "description": "`core/harness/hooks.py` uses Rich for logging. It should use Python's standard `logging` module — hooks run in subprocess contexts where Rich may not be appropriate.\n\n**Implementation Steps:**\n1. Replace `from rich.console import Console` with `import logging`\n2. Replace `console.print()` calls with `logger.info()`, `logger.debug()`, etc.\n3. Configure logging format in hook entry point\n4. Verify hook forensics still work correctly\n\n**Files:** src/cub/core/harness/hooks.py", "assignee": "cub-20260128-185726", "labels": ["phase-2", "core", "cleanup", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-b1b", "created_at": "2026-01-28T17:54:46.169467", "updated_at": "2026-01-28T19:18:27.819752", "closed_at": "2026-01-28T19:18:27.819748", "acceptanceCriteria": ["Zero Rich imports in `core/harness/hooks.py`", "Hook logging works in subprocess contexts", "Forensics JSONL output unchanged"], "notes": "[Closed: 2026-01-28T19:18:27.819754] Completed by autonomous execution", "complexity_label": "low", "model_label": "haiku", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1b.5", "title": "Verify zero Rich imports in core and add CI gate", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Final verification that the boundary is clean, plus a CI check to prevent regression.\n\n**Implementation Steps:**\n1. Run `grep -r \"from rich\" src/cub/core/` and verify zero results\n2. Run `grep -r \"import rich\" src/cub/core/` and verify zero results\n3. Add a test that programmatically checks no Rich imports in core\n4. Verify `mypy src/cub` passes clean\n\n**Files:** tests/test_architecture.py", "assignee": "cub-20260128-185726", "labels": ["phase-2", "core", "cleanup", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-b1b", "created_at": "2026-01-28T17:54:46.169492", "updated_at": "2026-01-28T19:20:10.863075", "closed_at": "2026-01-28T19:20:10.863070", "acceptanceCriteria": ["`grep -r \"from rich\\|import rich\" src/cub/core/` returns nothing", "Automated test enforces the boundary", "All commands work unchanged from user's perspective"], "notes": "[Closed: 2026-01-28T19:20:10.863078] Completed by autonomous execution", "complexity_label": "low", "model_label": "haiku", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1c.1", "title": "Create service layer foundation and RunService", "status": "closed", "priority": "P1", "issue_type": "task", "description": "RunService wraps the newly-extracted `core/run/` package, providing the clean API that CLI and future interfaces call. This establishes the service layer pattern.\n\n**Implementation Steps:**\n1. Create `src/cub/core/services/__init__.py` package\n2. Create `src/cub/core/services/run.py` with `RunService` class\n3. `RunService.from_config(config)` factory method\n4. `RunService.execute(run_config) -> Iterator[RunEvent]` delegates to `core/run/loop.py`\n5. `RunService.run_once(task_id) -> RunResult` convenience method\n6. Refactor `cli/run.py` to use `RunService` instead of calling `core/run/` directly\n7. Write service-level integration tests\n\n**Files:** src/cub/core/services/__init__.py, src/cub/core/services/run.py, src/cub/cli/run.py, tests/test_service_run.py", "assignee": "cub-20260128-192025", "labels": ["phase-3", "core", "architecture", "model:opus", "complexity:high", "blocking"], "dependsOn": [], "blocks": ["cub-b1c.2", "cub-b1c.3", "cub-b1c.4"], "parent": "cub-b1c", "created_at": "2026-01-28T17:54:46.169509", "updated_at": "2026-01-28T19:30:32.960816", "closed_at": "2026-01-28T19:30:32.960778", "acceptanceCriteria": ["`RunService` provides the complete API for task execution", "`cli/run.py` only calls `RunService`, not domain modules directly", "Service is stateless — configuration passed in, no globals", "Tests verify service orchestration"], "notes": "[Closed: 2026-01-28T19:30:32.960820] Completed by autonomous execution", "complexity_label": "high", "model_label": "opus", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1c.2", "title": "Create StatusService and LedgerService", "status": "closed", "priority": "P1", "issue_type": "task", "description": "StatusService aggregates project state from multiple sources. LedgerService wraps ledger reader/writer. Both are needed by the suggestion engine.\n\n**Implementation Steps:**\n1. Create `src/cub/core/services/status.py` with `StatusService`\n2. `summary() -> ProjectStats` — aggregate from tasks, ledger, git\n3. `progress(epic_id) -> EpicProgress` — epic-level progress\n4. Create `src/cub/core/services/ledger.py` with `LedgerService`\n5. `query(filters) -> list[LedgerEntry]`, `recent(n) -> list[LedgerEntry]`, `stats(period) -> LedgerStats`\n6. Define `ProjectStats`, `EpicProgress`, `LedgerStats` models\n7. Refactor `cli/status.py` and `cli/ledger.py` to use services\n\n**Files:** src/cub/core/services/status.py, src/cub/core/services/ledger.py, src/cub/core/services/models.py, src/cub/cli/status.py, src/cub/cli/ledger.py", "assignee": "cub-20260128-192025", "labels": ["phase-3", "core", "architecture", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1c", "created_at": "2026-01-28T17:54:46.169529", "updated_at": "2026-01-28T19:43:16.990826", "closed_at": "2026-01-28T19:43:16.990819", "acceptanceCriteria": ["`StatusService.summary()` returns structured project stats", "`LedgerService` wraps all ledger operations", "`cub status` and `cub ledger` commands work via services", "Models are Pydantic, serializable"], "notes": "[Closed: 2026-01-28T19:43:16.990832] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1c.3", "title": "Create LaunchService for environment detection and harness launch", "status": "closed", "priority": "P1", "issue_type": "task", "description": "LaunchService handles the core logic for bare `cub`: detect environment, determine if nested, launch harness with context. This is the service that `cli/default.py` will call.\n\n**Implementation Steps:**\n1. Create `src/cub/core/launch/__init__.py` package\n2. Create `src/cub/core/launch/detector.py` with `detect_environment() -> EnvironmentInfo`\n3. Check `CUB_SESSION_ACTIVE`, `CLAUDE_CODE`, `CLAUDE_PROJECT_DIR` env vars\n4. Create `src/cub/core/launch/launcher.py` with `launch_harness(config, context)`\n5. Implement harness binary resolution, flag assembly, `exec` call\n6. Create `src/cub/core/launch/models.py` with `EnvironmentInfo`, `LaunchConfig`\n7. Create `src/cub/core/services/launch.py` with `LaunchService` wrapper\n8. Write tests with mocked environment variables\n\n**Files:** src/cub/core/launch/detector.py, src/cub/core/launch/launcher.py, src/cub/core/launch/models.py, src/cub/core/services/launch.py, tests/test_launch.py", "assignee": "cub-20260128-192025", "labels": ["phase-3", "core", "architecture", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1c", "created_at": "2026-01-28T17:54:46.169545", "updated_at": "2026-01-28T19:49:58.382182", "closed_at": "2026-01-28T19:49:58.382177", "acceptanceCriteria": ["`detect_environment()` correctly identifies terminal, harness, and nested contexts", "`launch_harness()` assembles correct `claude` CLI invocation", "`--resume` and `--continue` flags pass through correctly", "`CUB_SESSION_ACTIVE` and `CUB_SESSION_ID` set in child environment", "Tests cover all three environment contexts"], "notes": "[Closed: 2026-01-28T19:49:58.382184] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1c.4", "title": "Enhance TaskService with ready(), stale_epics(), and claims", "status": "closed", "priority": "P1", "issue_type": "task", "description": "TaskService already exists but needs additional methods for the suggestion engine and welcome message. `ready()` and `stale_epics()` are key data sources for suggestions.\n\n**Implementation Steps:**\n1. Add `ready() -> list[Task]` to TaskService — tasks with no blockers, ordered by priority\n2. Add `stale_epics() -> list[Epic]` — epics where all child tasks are closed but epic is open\n3. Add `claim(task_id, session_id) -> Task` — mark task as in-progress for a session\n4. Add `close(task_id, reason) -> Task` — close task with reason\n5. Ensure methods work with both beads and JSONL backends\n6. Write tests for each method with both backends\n\n**Files:** src/cub/core/tasks/service.py, tests/test_task_service.py", "assignee": "cub-20260128-192025", "labels": ["phase-3", "core", "architecture", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1c", "created_at": "2026-01-28T17:54:46.169561", "updated_at": "2026-01-28T19:58:57.828806", "closed_at": "2026-01-28T19:58:57.828802", "acceptanceCriteria": ["`TaskService.ready()` returns correctly filtered and ordered tasks", "`TaskService.stale_epics()` detects epics ready to close", "Works with beads and JSONL backends", "Tests cover edge cases (no tasks, all blocked, mixed states)"], "notes": "[Closed: 2026-01-28T19:58:57.828808] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1d.1", "title": "Create suggestion models and data sources", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Define the data models for suggestions and implement the four data source adapters (tasks, git, ledger, milestones) that feed the ranking engine.\n\n**Implementation Steps:**\n1. Create `src/cub/core/suggestions/__init__.py` package\n2. Create `src/cub/core/suggestions/models.py` with `Suggestion`, `ProjectSnapshot`, `SuggestionCategory` enum\n3. Create `src/cub/core/suggestions/sources.py` with source protocol and implementations:\n4. Each source implements `get_suggestions() -> list[Suggestion]`\n5. Write tests with fixture data mirroring current cub project state\n\n**Files:** src/cub/core/suggestions/models.py, src/cub/core/suggestions/sources.py, tests/test_suggestions_sources.py", "assignee": "cub-20260128-195914", "labels": ["phase-4", "core", "feature", "model:sonnet", "complexity:medium", "blocking"], "dependsOn": [], "blocks": ["cub-b1d.2", "cub-b1d.3"], "parent": "cub-b1d", "created_at": "2026-01-28T17:54:46.169582", "updated_at": "2026-01-28T20:09:46.523423", "closed_at": "2026-01-28T20:09:46.523370", "acceptanceCriteria": ["All four sources produce relevant suggestions from real project data", "`TaskSource` detects the 9 stale epics in current project", "`GitSource` detects unpushed work and stale branches", "`MilestoneSource` infers 0.30 alpha target from sketches/CHANGELOG", "Models are Pydantic, serializable"], "notes": "[Closed: 2026-01-28T20:09:46.523427] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1d.2", "title": "Implement ranking algorithm and engine", "status": "closed", "priority": "P1", "issue_type": "task", "description": "The ranking algorithm scores and orders suggestions from all sources. The engine composes sources, applies ranking, and provides the public API.\n\n**Implementation Steps:**\n1. Create `src/cub/core/suggestions/ranking.py` with `rank_suggestions(suggestions) -> list[Suggestion]`\n2. Implement scoring: `base_priority × urgency_multiplier × recency_decay`\n3. Create `src/cub/core/suggestions/engine.py` with `SuggestionEngine` class\n4. `get_suggestions(limit) -> list[Suggestion]` — ranked list\n5. `get_welcome() -> WelcomeMessage` — stats + top suggestions + skills\n6. `get_next_action() -> Suggestion` — single best recommendation\n7. Write tests with deterministic fixture data to verify ranking order\n\n**Files:** src/cub/core/suggestions/ranking.py, src/cub/core/suggestions/engine.py, tests/test_suggestions_engine.py", "assignee": "cub-20260128-195914", "labels": ["phase-4", "core", "feature", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1d", "created_at": "2026-01-28T17:54:46.169599", "updated_at": "2026-01-28T20:15:09.194747", "closed_at": "2026-01-28T20:15:09.194743", "acceptanceCriteria": ["Stale epic closure ranks above low-priority ready tasks", "P0 tasks rank above P2 tasks", "Milestone blockers rank high when release target detected", "`get_welcome()` produces a complete `WelcomeMessage` with stats", "Ranking is deterministic for same input"], "notes": "[Closed: 2026-01-28T20:15:09.194749] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1d.3", "title": "Wire SuggestionEngine into services and dogfood", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Connect the engine to real project data via services and validate it produces useful suggestions for the cub project itself.\n\n**Implementation Steps:**\n1. Create `src/cub/core/services/suggestions.py` as the service wrapper\n2. Wire `SuggestionEngine` to use `TaskService`, `LedgerService`, `StatusService`\n3. Add a CLI command for testing: `cub suggest` (or add to `cub status`)\n4. Run against the current cub project and verify suggestions are sensible\n5. Iterate on ranking weights based on dogfooding results\n6. Document the suggestion categories and their use cases\n\n**Files:** src/cub/core/services/suggestions.py, src/cub/cli/suggest.py, tests/test_suggestions_integration.py", "assignee": "cub-20260128-195914", "labels": ["phase-4", "core", "feature", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1d", "created_at": "2026-01-28T17:54:46.169615", "updated_at": "2026-01-28T20:22:32.062910", "closed_at": "2026-01-28T20:22:32.062906", "acceptanceCriteria": ["`cub suggest` (or equivalent) produces useful output for cub project", "Suggestions include stale epics, ready tasks, and milestone awareness", "Output is human-readable and actionable", "Engine handles empty projects gracefully (new project with no tasks)"], "notes": "[Closed: 2026-01-28T20:22:32.062912] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1e.1", "title": "Implement bare cub default command handler", "status": "closed", "priority": "P0", "issue_type": "task", "description": "This is the primary user-facing deliverable. Bare `cub` detects the environment, generates a welcome message with suggestions, and either launches the harness (terminal) or shows inline status (nested/harness).\n\n**Implementation Steps:**\n1. Create `src/cub/cli/default.py` with the default command function\n2. Wire into `cli/__init__.py`: replace `no_args_is_help=True` with callback that invokes default\n3. Accept `--resume` and `--continue` flags\n4. Call `LaunchService.detect_environment()` to determine context\n5. If nested/harness: call `SuggestionEngine.get_welcome()`, render with Rich, exit\n6. If terminal: generate welcome, resolve harness, launch with `LaunchService.launch_harness()`\n7. Set `CUB_SESSION_ACTIVE=1` and `CUB_SESSION_ID` in launched harness environment\n8. Handle edge cases: no harness available, no project initialized, help flag\n\n**Files:** src/cub/cli/default.py, src/cub/cli/__init__.py, tests/test_default_command.py", "assignee": "cub-20260128-202245", "labels": ["phase-5", "cli", "feature", "model:opus", "complexity:high", "blocking"], "dependsOn": [], "blocks": ["cub-b1e.2", "cub-b1e.3"], "parent": "cub-b1e", "created_at": "2026-01-28T17:54:46.169633", "updated_at": "2026-01-28T20:31:26.493282", "closed_at": "2026-01-28T20:31:26.493257", "acceptanceCriteria": ["`cub` (no args) launches Claude Code with welcome context", "`cub --resume` passes `--resume` to Claude Code", "`cub --continue` passes `--continue` to Claude Code", "`cub` inside Claude Code shows inline status + suggestions (no nesting)", "`cub` with no harness available shows helpful error", "`cub --help` still works (shows help, not default action)", "Welcome message includes project stats and top suggestion"], "notes": "[Closed: 2026-01-28T20:31:26.493284] Completed by autonomous execution", "complexity_label": "high", "model_label": "opus", "is_ready": false, "priority_numeric": 0}
{"id": "cub-b1e.2", "title": "Design and implement welcome message format", "status": "closed", "priority": "P1", "issue_type": "task", "description": "The welcome message is the first thing users see. It needs to be concise, opinionated, and immediately useful. It renders differently in terminal (Rich formatting) vs inline (plain text for harness context).\n\n**Implementation Steps:**\n1. Create `src/cub/core/launch/welcome.py` with `generate_welcome(snapshot) -> WelcomeMessage`\n2. Design terminal format (Rich):\n3. Design harness context format (plain text for system prompt injection)\n4. Create Rich renderer in `cli/default.py` for terminal output\n5. Test with current cub project state\n\n**Files:** src/cub/core/launch/welcome.py, src/cub/cli/default.py, tests/test_welcome.py", "assignee": "cub-20260128-202245", "labels": ["phase-5", "cli", "feature", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1e", "created_at": "2026-01-28T17:54:46.169652", "updated_at": "2026-01-28T20:37:11.972618", "closed_at": "2026-01-28T20:37:11.972614", "acceptanceCriteria": ["Welcome message shows version, task counts, and last activity", "Top suggestion is opinionated with rationale and command", "Available skills listed for discoverability", "Terminal and harness formats both look good", "Handles empty project gracefully (no tasks, no history)"], "notes": "[Closed: 2026-01-28T20:37:11.972622] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1e.3", "title": "Integration testing and edge cases", "status": "closed", "priority": "P1", "issue_type": "task", "description": "The bare cub command has many edge cases that need testing: no project, no harness, nested sessions, resume/continue, different backends.\n\n**Implementation Steps:**\n1. Write integration test: bare cub in fresh directory (no `.cub/`)\n2. Write integration test: bare cub with JSONL backend\n3. Write integration test: bare cub with beads backend\n4. Write integration test: bare cub with `CUB_SESSION_ACTIVE=1` set\n5. Write integration test: bare cub with `--resume`\n6. Write integration test: bare cub when no harness available\n7. Test that `cub --help` still shows help text\n8. Test that `cub <subcommand>` still routes to subcommands normally\n\n**Files:** tests/test_default_command_integration.py", "assignee": "cub-20260128-202245", "labels": ["phase-5", "cli", "test", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1e", "created_at": "2026-01-28T17:54:46.169673", "updated_at": "2026-01-28T20:46:03.745287", "closed_at": "2026-01-28T20:46:03.745282", "acceptanceCriteria": ["All integration tests pass", "No regressions in existing subcommand routing", "Edge cases produce helpful error messages, not crashes", "`--help` behavior preserved"], "notes": "[Closed: 2026-01-28T20:46:03.745289] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-b1f.1", "title": "Create /cub meta-skill for in-session discovery", "status": "closed", "priority": "P2", "issue_type": "task", "description": "Users inside a harness session need to discover what cub skills are available. A `/cub` meta-skill lists available skills, common commands, and current project status.\n\n**Implementation Steps:**\n1. Create `.claude/commands/cub.md` as the meta-skill\n2. Include: list of available `/cub:*` skills with one-line descriptions\n3. Include: common `cub` CLI commands runnable via Bash (task ready, status, run)\n4. Include: brief explanation of modes (conversational, structured, supervised, autonomous)\n5. Include: dynamic project state (injected via template variables or by running `cub status`)\n\n**Files:** .claude/commands/cub.md", "assignee": "cub-20260128-204617", "labels": ["phase-6", "docs", "feature", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1f", "created_at": "2026-01-28T17:54:46.169693", "updated_at": "2026-01-28T20:54:38.292608", "closed_at": "2026-01-28T20:54:38.292604", "acceptanceCriteria": ["`/cub` skill exists and is invocable from Claude Code", "Lists all available `/cub:*` skills", "Lists common CLI commands", "Provides enough context for a user to navigate cub's capabilities"], "notes": "[Closed: 2026-01-28T20:54:38.292610] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 2}
{"id": "cub-b1f.2", "title": "Update CLAUDE.md with service architecture and skill reference", "status": "closed", "priority": "P2", "issue_type": "task", "description": "CLAUDE.md needs to reflect the new core/interface architecture so that harness sessions (and agents) understand cub's structure. Also document available skills.\n\n**Implementation Steps:**\n1. Update CLAUDE.md architecture section to reflect service layer\n2. Add \"Available Skills\" section listing all `/cub:*` skills\n3. Add \"Cub Commands\" section with commonly-used CLI commands\n4. Update project structure diagram to show `core/services/`, `core/run/`, `core/suggestions/`, `core/launch/`\n5. Add note about bare `cub` behavior and nesting detection\n6. Remove any outdated references to old architecture\n\n**Files:** CLAUDE.md", "assignee": "cub-20260128-204617", "labels": ["phase-6", "docs", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1f", "created_at": "2026-01-28T17:54:46.169709", "updated_at": "2026-01-28T21:05:03.067296", "closed_at": "2026-01-28T21:05:03.067292", "acceptanceCriteria": ["CLAUDE.md reflects current service layer architecture", "Skills section lists all available skills with descriptions", "Project structure diagram is accurate", "A harness session loading CLAUDE.md gets accurate information"], "notes": "[Closed: 2026-01-28T21:05:03.067297] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 2}
{"id": "cub-b1f.3", "title": "End-to-end validation of full flow", "status": "closed", "priority": "P1", "issue_type": "task", "description": "Final validation that the entire flow works: bare `cub` → harness → use skills → run tasks → exit. This is the acceptance test for the whole feature.\n\n**Implementation Steps:**\n1. Manual test: run `cub` from terminal, verify welcome + harness launch\n2. Manual test: inside harness, run `/cub` to see available skills\n3. Manual test: inside harness, run `/cub:spec` to start a spec\n4. Manual test: inside harness, run `cub task ready` to see tasks\n5. Manual test: inside harness, run `cub run --once` for foreground task\n6. Manual test: run `cub` inside the harness (verify nesting prevention)\n7. Document any issues found, create follow-up tasks if needed\n\n**Files:** (manual testing, no code changes expected)", "assignee": "cub-20260128-204617", "labels": ["phase-6", "test", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-b1f", "created_at": "2026-01-28T17:54:46.169724", "updated_at": "2026-01-28T20:52:34.691040", "closed_at": "2026-01-28T20:52:34.691014", "acceptanceCriteria": ["Full flow works without crashes or confusing behavior", "Mode transitions feel natural", "Nesting prevention works correctly", "Any issues found are documented as follow-up tasks"], "notes": "[Closed: 2026-01-28T20:52:34.691043] Completed by autonomous execution", "complexity_label": "medium", "model_label": "sonnet", "is_ready": false, "priority_numeric": 1}
{"id": "cub-p1t", "title": "cub-task-parity #1: Protocol Extensions & DependencyGraph", "status": "open", "priority": "P0", "issue_type": "epic", "description": "Extend the TaskBackend protocol with 7 new methods, implement them in BeadsBackend and JsonlBackend, extend `update_task` signature, and build the DependencyGraph class. This is the foundation that everything else depends on.", "assignee": null, "labels": ["phase-1", "complexity:high", "model:sonnet"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:45:10.091591", "updated_at": "2026-01-29T11:45:10.091614", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "high", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-p2c", "title": "cub-task-parity #2: CLI Subcommands", "status": "open", "priority": "P1", "issue_type": "epic", "description": "Add CLI commands for all new protocol operations. Each command supports three output modes: Rich (default), `--json`, `--agent`.", "assignee": null, "labels": ["phase-2", "complexity:medium", "model:sonnet"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:45:10.092044", "updated_at": "2026-01-29T11:45:10.092045", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p3s", "title": "cub-task-parity #3: Skill & Documentation Updates", "status": "open", "priority": "P1", "issue_type": "epic", "description": "Update all skills, router, and documentation to reference `cub task` exclusively. Remove `bd` from user-facing content.", "assignee": null, "labels": ["phase-3", "complexity:low", "model:haiku"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:45:10.092066", "updated_at": "2026-01-29T11:45:10.092067", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p1t.1", "title": "Extend TaskBackend protocol with 7 new methods", "status": "open", "priority": "P0", "issue_type": "task", "description": "The protocol needs 7 new methods for full lifecycle coverage. Also extend `update_task` to accept `title`, `priority`, and `notes` parameters. Create a `TaskBackendDefaults` mixin with default implementations for methods that can be derived from existing operations.\n\n**Implementation Steps:**\n1. Add 7 new method signatures to `TaskBackend` protocol in `backend.py`: `add_dependency`, `remove_dependency`, `list_blocked_tasks`, `reopen_task`, `delete_task`, `add_label`, `remove_label`\n2. Extend `update_task` signature with optional `title: str | None`, `priority: int | None`, `notes: str | None` parameters\n3. Create `TaskBackendDefaults` mixin class with default implementations:\n4. Add `blocked: int = 0` field to `TaskCounts` model\n5. Update type annotations and docstrings for all new methods\n\n**Files:** src/cub/core/tasks/backend.py, src/cub/core/tasks/models.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-p1t.2", "cub-p1t.3", "cub-p1t.4"], "parent": "cub-p1t", "created_at": "2026-01-29T11:46:17.463297", "updated_at": "2026-01-29T11:46:17.463329", "closed_at": null, "acceptanceCriteria": ["`TaskBackend` protocol has 19 methods (12 existing + 7 new)", "`update_task` accepts `title`, `priority`, `notes` optional params", "`TaskBackendDefaults` mixin has working default implementations", "`TaskCounts.blocked` field exists", "mypy passes with strict mode", "All new methods have complete docstrings"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-p1t.2", "title": "Implement new protocol methods in BeadsBackend", "status": "open", "priority": "P0", "issue_type": "task", "description": "BeadsBackend wraps the `bd` CLI. Each new protocol method needs a corresponding `bd` command wrapper. Follow the existing `_run_bd` pattern — bd commands that don't return JSON need a follow-up `get_task()` call.\n\n**Implementation Steps:**\n1. `add_dependency(task_id, depends_on)` — run `bd dep add <task_id> <depends_on>`, then `get_task(task_id)`\n2. `remove_dependency(task_id, depends_on)` — run `bd dep remove <task_id> <depends_on>`, then `get_task(task_id)`\n3. `list_blocked_tasks(parent?)` — run `bd blocked --json` (or `bd list --status open --json` and filter), parse JSON output\n4. `reopen_task(task_id)` — run `bd update <id> --status open`, then `get_task(task_id)`\n5. `delete_task(task_id)` — run `bd delete <id>`, return True on success\n6. `add_label(task_id, label)` — run `bd label add <id> <label>`, then `get_task(task_id)`\n7. `remove_label(task_id, label)` — run `bd label remove <id> <label>`, then `get_task(task_id)`\n8. Extend `update_task` to pass `--title`, `--priority`, `--notes` flags when provided\n9. Update `get_task_counts` to include blocked count\n\n**Files:** src/cub/core/tasks/beads.py, tests/test_beads_backend.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-p1t.5"], "parent": "cub-p1t", "created_at": "2026-01-29T11:46:17.463498", "updated_at": "2026-01-29T11:46:17.463499", "closed_at": null, "acceptanceCriteria": ["All 7 new methods implemented and callable", "`update_task` supports title, priority, notes parameters", "`get_task_counts` includes blocked count", "Error handling follows existing pattern (ValueError on not found)", "Unit tests pass for all new methods (mocked bd subprocess)"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-p1t.3", "title": "Implement new protocol methods in JsonlBackend", "status": "open", "priority": "P0", "issue_type": "task", "description": "JsonlBackend operates on an in-memory task list with atomic file writes. New methods manipulate task fields directly using existing Task model methods (`add_label()`, `remove_label()`, `reopen()`).\n\n**Implementation Steps:**\n1. `add_dependency(task_id, depends_on)` — find task, append to `depends_on` list, save\n2. `remove_dependency(task_id, depends_on)` — find task, remove from `depends_on` list, save\n3. `list_blocked_tasks(parent?)` — filter: status=OPEN, has depends_on, not all deps closed\n4. `reopen_task(task_id)` — find task, call `task.reopen()`, save\n5. `delete_task(task_id)` — remove task from list, save, return True\n6. `add_label(task_id, label)` — find task, call `task.add_label(label)`, save\n7. `remove_label(task_id, label)` — find task, call `task.remove_label(label)`, save\n8. Extend `update_task` to handle title, priority, notes field updates\n9. Update `get_task_counts` to include blocked count\n10. All mutations use existing atomic write pattern (temp file → rename)\n\n**Files:** src/cub/core/tasks/jsonl.py, tests/test_jsonl_backend.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-p1t.5"], "parent": "cub-p1t", "created_at": "2026-01-29T11:46:17.463520", "updated_at": "2026-01-29T11:46:17.463521", "closed_at": null, "acceptanceCriteria": ["All 7 new methods implemented and callable", "`update_task` supports title, priority, notes parameters", "`get_task_counts` includes blocked count", "Atomic writes for all mutations (no partial state)", "Unit tests pass for all new methods"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-p1t.4", "title": "Build DependencyGraph class", "status": "open", "priority": "P0", "issue_type": "task", "description": "Pure query object for dependency analysis. Built from a task list snapshot, immutable after construction. Used by AgentFormatter (agent-output spec) and `cub task blocked --agent` for impact analysis and recommendations. This is the critical piece that unblocks the agent-output spec.\n\n**Implementation Steps:**\n1. Create `src/cub/core/tasks/graph.py` with `DependencyGraph` class\n2. Constructor takes `list[Task]`, builds:\n3. `direct_unblocks(task_id) -> list[str]` — reverse edge lookup\n4. `transitive_unblocks(task_id) -> set[str]` — BFS from task through reverse edges\n5. `root_blockers(limit=5) -> list[tuple[str, int]]` — compute transitive_unblocks for all open tasks, sort by count descending\n6. `chains(limit=5) -> list[list[str]]` — DFS to find longest paths in forward graph\n7. `would_become_ready(task_id) -> list[str]` — for each task in `direct_unblocks()`, check if ALL other deps are in `_closed`\n8. `has_cycle() -> bool` — DFS with three-color marking (white/gray/black)\n9. `stats` property — return dict with node count, edge count, max chain depth\n10. Write comprehensive tests with topologies: empty, single task, linear chain, diamond, forest, cycle, mixed open/closed\n\n**Files:** src/cub/core/tasks/graph.py, tests/test_dependency_graph.py", "assignee": null, "labels": ["phase-1", "model:opus", "complexity:high"], "dependsOn": [], "blocks": ["cub-p1t.5"], "parent": "cub-p1t", "created_at": "2026-01-29T11:46:17.463535", "updated_at": "2026-01-29T11:46:17.463536", "closed_at": null, "acceptanceCriteria": ["All 6 query methods return correct results for test topologies", "Cycle detection works and doesn't cause infinite loops in other methods", "Closed tasks are correctly excluded from graph (treated as resolved)", "`would_become_ready` checks ALL deps, not just the given task", "`root_blockers` correctly ranks by transitive impact", "`chains` returns paths sorted by length descending", "mypy passes with strict mode", "Tests cover: empty graph, single node, linear chain (5 deep), diamond dependency, forest (disconnected), cycle, mixed open/closed states"], "notes": "", "complexity_label": "high", "model_label": "opus", "is_ready": true, "priority_numeric": 0}
{"id": "cub-p1t.5", "title": "Update BothBackend and write cross-backend tests", "status": "open", "priority": "P1", "issue_type": "task", "description": "BothBackend delegates to primary and secondary backends. It needs to delegate all 7 new methods and log divergences. Also write parametrized tests that verify the same operations work identically across both backends.\n\n**Implementation Steps:**\n1. Update `BothBackend` to delegate all 7 new methods (follow existing delegation pattern)\n2. Inherit from `TaskBackendDefaults` as fallback\n3. Add divergence logging for new methods\n4. Write parametrized pytest tests that run the same test cases against BeadsBackend (mocked) and JsonlBackend (temp files)\n5. Test scenarios: add/remove dependency, list blocked, reopen, delete, add/remove label\n6. Verify `DependencyGraph` produces consistent results from both backend outputs\n\n**Files:** src/cub/core/tasks/both.py, tests/test_task_backends.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-p1t", "created_at": "2026-01-29T11:46:17.463550", "updated_at": "2026-01-29T11:46:17.463550", "closed_at": null, "acceptanceCriteria": ["BothBackend delegates all 7 new methods", "Divergence logging works for new methods", "Parametrized tests pass against both backends", "DependencyGraph produces same results regardless of backend", "mypy passes"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p2c.1", "title": "Add cub task blocked command", "status": "open", "priority": "P1", "issue_type": "task", "description": "The most common gap — the router currently maps \"what's blocked\" to `bd blocked`. This command shows blocked tasks with optional epic filter. With `--agent`, it includes root blocker analysis and chain lengths from DependencyGraph.\n\n**Implementation Steps:**\n1. Add `blocked` command to task app in `cli/task.py`\n2. Parameters: `--epic` (filter), `--json`, `--agent`\n3. Rich output: table with ID, Priority, Title, Blocked By columns\n4. JSON output: task model dumps\n5. Agent output: call `AgentFormatter.format_blocked()` if available, otherwise fall back to a simple markdown table\n6. Build DependencyGraph from all tasks for analysis hints\n7. Show root blockers and chain summary in agent output\n\n**Files:** src/cub/cli/task.py", "assignee": null, "labels": ["phase-2", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-p2c", "created_at": "2026-01-29T11:46:17.463571", "updated_at": "2026-01-29T11:46:17.463572", "closed_at": null, "acceptanceCriteria": ["`cub task blocked` shows blocked tasks in Rich table", "`--epic` filter works", "`--json` outputs task list as JSON", "`--agent` outputs structured markdown with analysis", "Empty result shows helpful message (\"No blocked tasks\")", "CLI test covers all three output modes"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p2c.2", "title": "Add cub task dep add/remove and cub task label add/remove/list commands", "status": "open", "priority": "P1", "issue_type": "task", "description": "Dependency and label management subcommands. These are simple CRUD wrappers around protocol methods with confirmation output.\n\n**Implementation Steps:**\n1. Create `dep` sub-app with `add` and `remove` commands\n2. `cub task dep add <task> <depends-on>` — calls `add_dependency()`, prints confirmation\n3. `cub task dep remove <task> <depends-on>` — calls `remove_dependency()`, prints confirmation\n4. Enhance existing `dep list` to show both directions (what this task depends on AND what depends on it)\n5. Create `label` sub-app with `add`, `remove`, `list` commands\n6. `cub task label add <task> <label>` — calls `add_label()`, prints confirmation\n7. `cub task label remove <task> <label>` — calls `remove_label()`, prints confirmation\n8. `cub task label list <task>` — calls `get_task()`, displays labels\n9. All commands support `--json` for machine output\n\n**Files:** src/cub/cli/task.py", "assignee": null, "labels": ["phase-2", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-p2c", "created_at": "2026-01-29T11:46:17.463585", "updated_at": "2026-01-29T11:46:17.463586", "closed_at": null, "acceptanceCriteria": ["`cub task dep add/remove` work and confirm the operation", "`cub task dep list <id>` shows both directions", "`cub task label add/remove/list` work and confirm operations", "`--json` output works for all commands", "Error handling for invalid task IDs", "CLI tests for each command"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p2c.3", "title": "Add cub task reopen and cub task delete commands", "status": "open", "priority": "P1", "issue_type": "task", "description": "Lifecycle management commands. Reopen is straightforward. Delete is destructive and needs a confirmation prompt (skippable with `--force`).\n\n**Implementation Steps:**\n1. Add `reopen` command — calls `reopen_task()`, prints confirmation with task title\n2. Add `delete` command — prompts \"Delete task {id} '{title}'? [y/N]\" unless `--force` is passed\n3. Both support `--json` for machine output\n4. Error handling: task not found, task not in correct state (e.g., reopen a non-closed task)\n\n**Files:** src/cub/cli/task.py", "assignee": null, "labels": ["phase-2", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-p2c", "created_at": "2026-01-29T11:46:17.463596", "updated_at": "2026-01-29T11:46:17.463597", "closed_at": null, "acceptanceCriteria": ["`cub task reopen <id>` reopens a closed task", "`cub task delete <id>` prompts for confirmation", "`cub task delete <id> --force` skips confirmation", "Error messages for invalid states (reopen non-closed, delete non-existent)", "CLI tests"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p2c.4", "title": "Enhance existing cub task list, ready, create, update commands", "status": "open", "priority": "P1", "issue_type": "task", "description": "Existing commands need additional filters and flags to reach parity. `list` and `ready` need `--epic` and `--assignee` filters. `create` needs full flag exposure. `update` needs `--title`, `--priority`, `--notes`.\n\n**Implementation Steps:**\n1. `cub task list`: add `--epic` (filter by parent), `--assignee` (filter by assignee) options\n2. `cub task ready`: add `--epic` filter, add `--by impact|priority` ordering option (impact uses DependencyGraph)\n3. `cub task create`: ensure CLI exposes `--type`, `--priority`, `--epic` (as `--parent`), `--description`, `--depends-on` (comma-separated list)\n4. `cub task update`: add `--title`, `--priority`, `--notes` flags alongside existing `--description`, `--assignee`, `--status`\n5. For `ready --by impact`: build DependencyGraph, sort tasks by `transitive_unblocks` count descending\n\n**Files:** src/cub/cli/task.py", "assignee": null, "labels": ["phase-2", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-p2c", "created_at": "2026-01-29T11:46:17.463607", "updated_at": "2026-01-29T11:46:17.463607", "closed_at": null, "acceptanceCriteria": ["`cub task list --epic <id>` filters correctly", "`cub task list --assignee <name>` filters correctly", "`cub task ready --epic <id>` filters correctly", "`cub task ready --by impact` sorts by unblock count", "`cub task create` exposes all flags", "`cub task update` supports title, priority, notes", "CLI tests for new filters and flags"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p2c.5", "title": "Add cub task search command", "status": "open", "priority": "P2", "issue_type": "task", "description": "Full-text search across task titles and descriptions. BeadsBackend wraps `bd search`. JsonlBackend does substring match on title + description in memory. This is P2 but included since we're not excluding anything.\n\n**Implementation Steps:**\n1. Add `search_tasks(query: str) -> list[Task]` to `TaskBackend` protocol\n2. Implement in BeadsBackend: run `bd search <query> --json`, parse results\n3. Implement in JsonlBackend: case-insensitive substring match on title and description\n4. Add `search` command to task CLI: `cub task search <query>`\n5. Support `--json` and `--agent` output modes\n6. Show match count and results table\n\n**Files:** src/cub/core/tasks/backend.py, src/cub/core/tasks/beads.py, src/cub/core/tasks/jsonl.py, src/cub/cli/task.py", "assignee": null, "labels": ["phase-2", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-p2c", "created_at": "2026-01-29T11:46:17.463618", "updated_at": "2026-01-29T11:46:17.463619", "closed_at": null, "acceptanceCriteria": ["`cub task search \"auth\"` finds tasks with \"auth\" in title or description", "Works with both backends", "`--json` and Rich output modes work", "Empty results show helpful message", "Tests for both backends"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 2}
{"id": "cub-p3s.1", "title": "Update router skill and passthrough skills", "status": "open", "priority": "P1", "issue_type": "task", "description": "The router skill (`.claude/commands/cub.md`) currently maps \"what's blocked\" to `bd blocked`. Passthrough skills reference `bd` commands. Update all to use `cub task` equivalents with `--agent` flag.\n\n**Implementation Steps:**\n1. In `.claude/commands/cub.md`:\n2. In `.claude/commands/cub:tasks.md`:\n3. Review other skill files for any remaining `bd` references\n\n**Files:** .claude/commands/cub.md, .claude/commands/cub:tasks.md", "assignee": null, "labels": ["phase-3", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-p3s", "created_at": "2026-01-29T11:46:17.463629", "updated_at": "2026-01-29T11:46:17.463629", "closed_at": null, "acceptanceCriteria": ["Router skill has no `bd` references (except in \"power user\" context if desired)", "All task intent patterns route to `cub task` commands", "New subcommands (blocked, dep, label, reopen, delete, search) are in routing table", "`--agent` flag used in all command invocations within skills"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-p3s.2", "title": "Update CLAUDE.md and PROMPT.md documentation", "status": "open", "priority": "P2", "issue_type": "task", "description": "CLAUDE.md (agent instructions) and `.cub/PROMPT.md` (runloop instructions) reference `bd` commands in examples. Update all examples to use `cub task` equivalents. Keep `bd` mentioned only in the \"Pre-approved Commands\" section (bd is still available for power users).\n\n**Implementation Steps:**\n1. In CLAUDE.md:\n2. In `.cub/PROMPT.md`:\n3. Audit all `.md` files in `.cub/` directory for stale `bd` references\n\n**Files:** CLAUDE.md, .cub/PROMPT.md", "assignee": null, "labels": ["phase-3", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-p3s", "created_at": "2026-01-29T11:46:17.463639", "updated_at": "2026-01-29T11:46:17.463640", "closed_at": null, "acceptanceCriteria": ["CLAUDE.md examples use `cub task` not `bd` (except Pre-approved section)", "PROMPT.md task instructions use `cub task`", "No stale `bd` references in user-facing documentation", "`bd` still listed as pre-approved for power users"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 2}
{"id": "cub-a1f", "title": "agent-output #1: AgentFormatter & --agent Flag", "status": "open", "priority": "P0", "issue_type": "epic", "description": "Build the AgentFormatter module and wire `--agent` flags into Phase 1 CLI commands (task ready, task show, status, suggest). This is the core value — Claude gets structured, compact markdown with pre-computed analysis hints instead of raw Rich output.", "assignee": null, "labels": ["phase-1", "complexity:high", "model:sonnet"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:46:50.492408", "updated_at": "2026-01-29T11:46:50.492428", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "high", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-a2s", "title": "agent-output #2: Skill Updates & Router Integration", "status": "open", "priority": "P1", "issue_type": "epic", "description": "Update all passthrough skill files and the router skill to use `--agent` flag in their CLI invocations. This closes the loop: `/cub` → router → `cub task ready --agent` → structured markdown → Claude interprets.", "assignee": null, "labels": ["phase-2", "complexity:low", "model:haiku"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:46:50.492616", "updated_at": "2026-01-29T11:46:50.492617", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a3r", "title": "agent-output #3: Route Learning", "status": "open", "priority": "P1", "issue_type": "epic", "description": "Build the hook-based route learning system: observe cub command usage via hooks, compile frequency data at session end, surface compiled routes to the router skill via file reference.", "assignee": null, "labels": ["phase-3", "complexity:medium", "model:sonnet"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:46:50.492636", "updated_at": "2026-01-29T11:46:50.492636", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a4e", "title": "agent-output #4: Extended Commands", "status": "open", "priority": "P2", "issue_type": "epic", "description": "Add `--agent` support to Phase 2 and Phase 3 commands. These depend on task parity (cub-task-parity) landing for `blocked` and `list`, and doctor refactor for `doctor`.", "assignee": null, "labels": ["phase-4", "complexity:medium", "model:sonnet"], "dependsOn": [], "blocks": [], "parent": null, "created_at": "2026-01-29T11:46:50.492652", "updated_at": "2026-01-29T11:46:50.492653", "closed_at": null, "acceptanceCriteria": [], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 2}
{"id": "cub-a1f.1", "title": "Build AgentFormatter module with Phase 1 format methods", "status": "open", "priority": "P0", "issue_type": "task", "description": "The AgentFormatter is a collection of static methods that transform service-layer data into structured markdown for LLM consumption. Each method follows the envelope template: heading, summary line, data tables, truncation notice, analysis section. The formatter returns plain strings — no Rich, no console. DependencyGraph is an optional parameter; when None, analysis hints that require graph queries are omitted.\n\n**Implementation Steps:**\n1. Create `src/cub/core/services/agent_format.py` with `AgentFormatter` class\n2. Implement shared helpers:\n3. Implement `format_ready(tasks, graph=None)`:\n4. Implement `format_task_detail(task, graph=None, epic_progress=None)`:\n5. Implement `format_status(stats, epic_progress=None)`:\n6. Implement `format_suggestions(suggestions)`:\n7. Write snapshot tests for each method with representative inputs (0, 1, 10, 20 items)\n8. Write token budget test: assert output character count < 2000 for representative inputs\n\n**Files:** src/cub/core/services/agent_format.py, tests/test_agent_format.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:high"], "dependsOn": [], "blocks": ["cub-a1f.2"], "parent": "cub-a1f", "created_at": "2026-01-29T11:47:42.431379", "updated_at": "2026-01-29T11:47:42.431403", "closed_at": null, "acceptanceCriteria": ["All 4 format methods return valid markdown strings", "Output follows the envelope template (heading, summary, tables, truncation, analysis)", "Truncation works: shows all if ≤ 15 items, truncates to 10 with notice if > 15", "Analysis section omits graph-dependent hints when graph is None", "Analysis section includes graph-dependent hints when graph is provided", "No Rich or console dependencies — pure string operations", "Token budget: all representative outputs < 2000 characters", "mypy passes with strict mode", "Snapshot tests pass for each method"], "notes": "", "complexity_label": "high", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-a1f.2", "title": "Wire --agent flag into Phase 1 CLI commands", "status": "open", "priority": "P0", "issue_type": "task", "description": "Add `--agent` flag to `cub task ready`, `cub task show`, `cub status`, and `cub suggest`. Follow the existing `--json` pattern. When `--agent` is passed, call the corresponding AgentFormatter method and print the result. `--agent` wins silently over `--json` if both are passed. Include `_try_build_graph` helper that attempts to import DependencyGraph (returns None if not available yet).\n\n**Implementation Steps:**\n1. Create `_try_build_graph(backend)` helper function in `cli/task.py`:\n2. In `cub task ready`:\n3. In `cub task show`:\n4. In `cub status` (status.py):\n5. In `cub suggest` (suggest.py):\n6. Write CLI integration tests for each command with `--agent` flag\n\n**Files:** src/cub/cli/task.py, src/cub/cli/status.py, src/cub/cli/suggest.py", "assignee": null, "labels": ["phase-1", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-a1f", "created_at": "2026-01-29T11:47:42.431536", "updated_at": "2026-01-29T11:47:42.431537", "closed_at": null, "acceptanceCriteria": ["`cub task ready --agent` outputs structured markdown", "`cub task show <id> --agent` outputs structured markdown", "`cub status --agent` outputs structured markdown", "`cub suggest --agent` outputs structured markdown", "`--agent` takes precedence over `--json` silently", "`_try_build_graph` returns None gracefully when DependencyGraph not available", "`_try_build_graph` returns working graph when DependencyGraph is available", "CLI tests pass for all four commands"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 0}
{"id": "cub-a2s.1", "title": "Update passthrough skills and router to use --agent", "status": "open", "priority": "P1", "issue_type": "task", "description": "Seven passthrough skills exist and the router skill maps intent to CLI commands. Update all command invocations to include `--agent` so Claude always gets structured output when routing through skills. The router skill needs `--agent` on all CLI command mappings.\n\n**Implementation Steps:**\n1. Update `.claude/commands/cub:tasks.md`:\n2. Update `.claude/commands/cub:status.md`:\n3. Update `.claude/commands/cub:suggest.md`:\n4. Update `.claude/commands/cub:ledger.md`:\n5. Update `.claude/commands/cub:doctor.md`:\n6. Update `.claude/commands/cub.md` (router):\n7. Add instruction in router skill about how Claude should treat `--agent` output:\n\n**Files:** .claude/commands/cub.md, .claude/commands/cub:tasks.md, .claude/commands/cub:status.md, .claude/commands/cub:suggest.md, .claude/commands/cub:ledger.md, .claude/commands/cub:doctor.md", "assignee": null, "labels": ["phase-2", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-a2s", "created_at": "2026-01-29T11:47:42.431554", "updated_at": "2026-01-29T11:47:42.431555", "closed_at": null, "acceptanceCriteria": ["All Phase 1 commands in skill files use `--agent`", "Router skill intent table uses `--agent` for all supported commands", "Router skill includes instruction on treating analysis hints", "Skills for commands without `--agent` support are left unchanged", "No broken command invocations"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a3r.1", "title": "Add route observation to cub-hook.sh", "status": "open", "priority": "P1", "issue_type": "task", "description": "The existing `cub-hook.sh` fast-path filter fires on every Bash tool use. It already detects `cub` commands for the symbiotic workflow. Extend it to log command usage to `.cub/route-log.jsonl`. This is 4 lines of shell — minimal latency impact.\n\n**Implementation Steps:**\n1. In `.cub/scripts/hooks/cub-hook.sh`, in the PostToolUse/Bash handler where `cub ` commands are detected:\n2. Add `.cub/route-log.jsonl` to `.gitignore` (raw log is local-only)\n3. Ensure the logging doesn't interfere with existing hook behavior (the line is additive)\n4. Test manually: run a `cub task ready` in Claude Code, verify log entry appears\n\n**Files:** .cub/scripts/hooks/cub-hook.sh, .gitignore", "assignee": null, "labels": ["phase-3", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": ["cub-a3r.2"], "parent": "cub-a3r", "created_at": "2026-01-29T11:47:42.431572", "updated_at": "2026-01-29T11:47:42.431572", "closed_at": null, "acceptanceCriteria": ["Every `cub *` command executed via Bash tool use is logged to `.cub/route-log.jsonl`", "Log entries have ISO timestamp and full command string", "`.cub/route-log.jsonl` is in `.gitignore`", "Existing hook behavior is unchanged", "No measurable latency impact (shell echo + redirect)"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a3r.2", "title": "Build route compiler and cub routes CLI", "status": "open", "priority": "P1", "issue_type": "task", "description": "The route compiler reads the raw log, normalizes commands (strips task IDs, file paths), aggregates by frequency, filters noise (count < 3), and writes a markdown table to `.cub/learned-routes.md`. This compiled file is git-tracked and shared with the team. The compiler is triggered by the Stop hook at session end.\n\n**Implementation Steps:**\n1. Create `src/cub/core/routes/compiler.py`:\n2. Create `src/cub/core/routes/__init__.py`\n3. Create `src/cub/cli/routes.py`:\n4. Register routes app in `src/cub/cli/__init__.py`\n5. Add Stop hook trigger in `cub-hook.sh`:\n6. Write tests for `normalize_command` with edge cases (various command patterns)\n7. Write tests for `compile_routes` with sample JSONL input\n8. Write tests for `render_learned_routes` output format\n\n**Files:** src/cub/core/routes/__init__.py, src/cub/core/routes/compiler.py, src/cub/cli/routes.py, src/cub/cli/__init__.py, .cub/scripts/hooks/cub-hook.sh, tests/test_route_compiler.py", "assignee": null, "labels": ["phase-3", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-a3r.3"], "parent": "cub-a3r", "created_at": "2026-01-29T11:47:42.431583", "updated_at": "2026-01-29T11:47:42.431584", "closed_at": null, "acceptanceCriteria": ["`normalize_command` correctly strips IDs and values from 10+ command patterns", "`compile_routes` aggregates correctly, filters count < 3, sorts by frequency", "`compile_routes` handles max_entries truncation for large logs", "`render_learned_routes` produces valid markdown table", "`cub routes compile` writes `.cub/learned-routes.md`", "`cub routes show` displays the compiled routes", "`cub routes clear` deletes both files", "Stop hook triggers compilation in background", "mypy passes", "Tests pass for normalizer, compiler, and renderer"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a3r.3", "title": "Add learned routes section to router skill", "status": "open", "priority": "P1", "issue_type": "task", "description": "The router skill needs to reference the compiled routes file so Claude can use frequency data as a tiebreaker for ambiguous intent. This is the only point where LLM judgment enters the route learning system.\n\n**Implementation Steps:**\n1. Add a \"Learned Routes\" section to `.claude/commands/cub.md`:\n2. Place this section after the \"Execution Rules\" section and before \"Examples\"\n3. The `@` prefix ensures Claude Code injects the file content into context\n\n**Files:** .claude/commands/cub.md", "assignee": null, "labels": ["phase-3", "model:haiku", "complexity:low"], "dependsOn": [], "blocks": [], "parent": "cub-a3r", "created_at": "2026-01-29T11:47:42.431594", "updated_at": "2026-01-29T11:47:42.431595", "closed_at": null, "acceptanceCriteria": ["Router skill references `@.cub/learned-routes.md`", "Instructions tell Claude to use learned routes as tiebreaker, not override", "Section is positioned logically in the skill file", "Skill still works correctly when learned-routes.md doesn't exist yet"], "notes": "", "complexity_label": "low", "model_label": "haiku", "is_ready": true, "priority_numeric": 1}
{"id": "cub-a4e.1", "title": "Add AgentFormatter methods for blocked, list, and ledger", "status": "open", "priority": "P2", "issue_type": "task", "description": "Three more commands get `--agent` support. `format_blocked` uses DependencyGraph heavily (root blockers, chain visualization). `format_list` is a general-purpose task table. `format_ledger` shows recent completions with cost summary. These depend on the task parity spec having landed `cub task blocked` and `cub task list` enhancements.\n\n**Implementation Steps:**\n1. Add `format_blocked(tasks, graph=None)` to AgentFormatter:\n2. Add `format_list(tasks)` to AgentFormatter:\n3. Add `format_ledger(entries, stats=None)` to AgentFormatter:\n4. Write snapshot tests for each method\n5. Write token budget tests\n\n**Files:** src/cub/core/services/agent_format.py, tests/test_agent_format.py", "assignee": null, "labels": ["phase-4", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": ["cub-a4e.2"], "parent": "cub-a4e", "created_at": "2026-01-29T11:47:42.431604", "updated_at": "2026-01-29T11:47:42.431605", "closed_at": null, "acceptanceCriteria": ["`format_blocked` produces correct output with and without graph", "`format_blocked` with graph shows root blockers and chains", "`format_list` produces correct output with truncation", "`format_ledger` produces correct output with cost summary", "All outputs < 2000 characters for representative inputs", "Snapshot tests pass"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 2}
{"id": "cub-a4e.2", "title": "Wire --agent flag into blocked, list, and ledger CLI commands", "status": "open", "priority": "P2", "issue_type": "task", "description": "Add `--agent` flag to `cub task blocked`, `cub task list`, and `cub ledger show`. These commands should already exist from the task parity spec. Wire in the AgentFormatter methods.\n\n**Implementation Steps:**\n1. In `cub task blocked` (cli/task.py):\n2. In `cub task list` (cli/task.py):\n3. In `cub ledger show` (cli/ledger.py):\n4. Update corresponding skill files to use `--agent`\n5. Write CLI tests\n\n**Files:** src/cub/cli/task.py, src/cub/cli/ledger.py, .claude/commands/cub:tasks.md, .claude/commands/cub:ledger.md", "assignee": null, "labels": ["phase-4", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-a4e", "created_at": "2026-01-29T11:47:42.431614", "updated_at": "2026-01-29T11:47:42.431615", "closed_at": null, "acceptanceCriteria": ["`cub task blocked --agent` outputs structured markdown", "`cub task list --agent` outputs structured markdown", "`cub ledger show --agent` outputs structured markdown", "Skill files updated to use `--agent` for these commands", "CLI tests pass"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 2}
{"id": "cub-a4e.3", "title": "Add --agent support for doctor command (requires refactor)", "status": "open", "priority": "P2", "issue_type": "task", "description": "The doctor command currently prints directly via Rich console. To support `--agent`, it needs to return structured diagnostic results instead. This is a refactor of the existing doctor command internals, not just adding a flag.\n\n**Implementation Steps:**\n1. Define `DiagnosticResult` model (or use existing if one exists):\n2. Refactor doctor command to collect `list[DiagnosticResult]` before rendering\n3. Add `format_doctor(checks: list[DiagnosticResult])` to AgentFormatter:\n4. Add `--agent` flag to `cub doctor` command\n5. If agent: call `AgentFormatter.format_doctor(checks)`, print\n6. Ensure existing Rich output is unchanged when `--agent` is not passed\n7. Update `cub:doctor.md` skill to use `--agent`\n8. Write tests for both the refactored data collection and agent formatting\n\n**Files:** src/cub/cli/doctor.py, src/cub/core/services/agent_format.py, .claude/commands/cub:doctor.md, tests/test_agent_format.py", "assignee": null, "labels": ["phase-4", "model:sonnet", "complexity:medium"], "dependsOn": [], "blocks": [], "parent": "cub-a4e", "created_at": "2026-01-29T11:47:42.431624", "updated_at": "2026-01-29T11:47:42.431625", "closed_at": null, "acceptanceCriteria": ["Doctor command collects structured `DiagnosticResult` list before rendering", "Existing Rich output is unchanged (no regression)", "`cub doctor --agent` outputs structured markdown", "`format_doctor` produces correct output", "Skill file updated", "Tests pass for both output modes"], "notes": "", "complexity_label": "medium", "model_label": "sonnet", "is_ready": true, "priority_numeric": 2}
