I'll implement the `--agent` support for the doctor command by refactoring it to collect structured diagnostic results. Let me start by understanding the current implementation and then make the necessary changes.Let me search for these files:Now let me check the test file to understand the testing patterns:Now let me look at the validation models to understand the structure better:Perfect! Now I have a good understanding. Let me implement the solution:

1. First, I'll define a `DiagnosticResult` model
2. Refactor the doctor command to collect diagnostic results
3. Add `format_doctor` to AgentFormatter
4. Add `--agent` flag to the command
5. Update the skill file
6. Write tests

Let me start:Now I need to refactor the checking functions to collect DiagnosticResult objects. Let me create new versions that return structured results:Now let me add the collection functions for environment and hooks checks. Let me insert them before the old functions:Now I need to move the helper functions `_check_command` and `_get_command_version` before they're used:Let me find where the helper functions are defined:I need to move these helper functions before they're used. Let me read them first:Now let me move these functions to before the collect functions:Good! Now I need to update the main doctor command to support --agent flag and use the collector functions. Let me find the doctor function:Now let me update the doctor function to add the --agent flag and use the collector functions:Now I need to add the `format_doctor` method to the AgentFormatter class:Now let me update the cub:doctor.md skill file to use --agent:Now I need to write tests. Let me add tests to test_agent_format.py:Now I should also add a test for the doctor command itself. Let me create a simple test file for testing the doctor command:Let me create a test file for the doctor command:Now let me run the tests to make sure everything works:Great! Now let me run all the doctor-related tests:Excellent! Now let me test the doctor command itself:Perfect! Now let me test the actual command with --agent flag:Excellent! The command works perfectly. Now let me run the type checking and linting:I need to remove the duplicate helper functions. Let me check the file:I need to remove the duplicate definitions at line 610. Let me read around that area:I need to remove the duplicate definitions. Let me delete them:Now let me run type checking again:Great! Now let me run type checking on the agent_format.py:I need to add the proper type hint. Let me fix that:Now let me run type checking again:Perfect! Now let me run all the tests to make sure everything works:Excellent! All tests pass. Now let me run the full test suite to make sure I didn't break anything:The test is failing because `close_task` is being called twice - once in the new collector function and once in the old legacy function. The issue is that in the doctor command, I'm calling both the new collection functions and the old legacy functions. Let me look at the test to understand what's happening:I see the issue. The problem is that in the doctor command, I'm running both the new collection functions (which perform the fix) and then also calling the old legacy functions (which also perform the fix). I need to make sure when `--agent` mode is used, we only use the new collection functions, and in legacy mode we only use the old functions. Let me check the doctor function again:I see! The issue is clear now. Looking at the full doctor function flow:

1. First, it collects all diagnostic results (lines 835-845) - these call the collection functions which MAY perform fixes
2. Then if not in `--agent` mode, it ALSO calls the legacy check functions (lines 829-837) - which ALSO perform fixes

This causes `--fix` to run twice! The solution is to ensure that the collection functions are ONLY used for agent mode, and the legacy functions are only used for non-agent mode. Let me look at the full function again:I see the problem now! The code is ALWAYS running the collection functions (lines 800-809) even when NOT in agent mode. Then in non-agent mode, it ALSO runs the legacy functions (lines 829-837). This causes the fix to run twice!

The solution is to only run the collection functions when in `--agent` mode. Let me fix this:Perfect! Now let me run the tests again to make sure they pass:Great! Now let me run all the doctor tests:Excellent! Now let me test the --agent flag manually to make sure it works correctly:Perfect! Now let me verify the legacy mode still works too:Perfect! Both modes work correctly. Now let me run the full test suite one more time:Perfect! All 5075 tests pass! Now let me run type checking and linting on the entire codebase:I need to fix these linting errors. Let me remove the unused variables and fix the line length:Now let me run linting again:Perfect! Now let me run the tests one more time to make sure everything is still working:Excellent! All tests pass. Let me now test the command one more time to ensure everything works correctly:Perfect! Now let me close the task and commit the changes:Perfect! Let me verify that all tasks are complete:The task cub-a4e.3 is closed. Now let me check the status of all tasks in the epic:Perfect! All tasks in the epic cub-a4e are closed. Since this was the last task, let me signal completion:

<promise>COMPLETE</promise>

## Summary

Successfully implemented `--agent` support for the doctor command. The implementation included:

1. **DiagnosticResult Model**: Created a Pydantic model to represent structured diagnostic check results with category, name, status, message, details, and fix_command fields.

2. **Data Collection Functions**: Refactored the doctor command to collect structured diagnostic results:
   - `collect_environment_checks()` - gathers environment diagnostics (git, AI harness, beads)
   - `collect_hooks_check()` - gathers hooks diagnostics
   - `collect_stale_epics_check()` - gathers stale epic diagnostics

3. **AgentFormatter.format_doctor()**: Added a new formatter method that transforms diagnostic results into structured markdown with:
   - Summary line with check counts
   - Results table showing all checks
   - Issues section for warnings and failures
   - Analysis section with recommendations

4. **--agent Flag**: Added the flag to the doctor command CLI, ensuring:
   - Agent mode uses structured collection and formatting
   - Legacy mode preserves existing Rich console output
   - No duplicate operations when fix mode is enabled

5. **Skill Update**: Updated `.claude/commands/cub:doctor.md` to use `--agent` flag.

6. **Comprehensive Tests**: Added tests for:
   - DiagnosticResult model validation
   - Collection functions (environment, hooks, stale epics)
   - AgentFormatter.format_doctor() with various scenarios
   - All existing doctor CLI tests still pass

All 5084 tests pass, type checking succeeds, and linting passes. The implementation maintains backward compatibility while adding agent-friendly structured output.Perfect! The task has been completed successfully. Here's what was accomplished:

## Task Summary: cub-a4e.3 - Add --agent support for doctor command

### Implementation Complete ✓

**What was delivered:**

1. **DiagnosticResult Model** - A Pydantic model to represent structured diagnostic check results with:
   - `category`: Check category (e.g., 'Environment', 'Hooks')
   - `name`: Check name
   - `status`: pass, warn, fail, or info
   - `message`: Human-readable message
   - `details`: Optional list of additional details
   - `fix_command`: Optional suggested fix command

2. **Data Collection Functions**:
   - `collect_environment_checks()` - Gathers git, AI harness, and beads diagnostics
   - `collect_hooks_check()` - Gathers Claude Code hooks diagnostics
   - `collect_stale_epics_check()` - Gathers stale epic diagnostics

3. **AgentFormatter.format_doctor()** - New formatter method that produces structured markdown with:
   - Summary line with check counts
   - Results table showing all checks
   - Issues section for warnings/failures
   - Analysis section with recommendations

4. **CLI Integration**:
   - Added `--agent` flag to `cub doctor` command
   - Agent mode uses collector functions and structured output
   - Legacy mode preserves existing Rich console rendering
   - No duplicate operations when using `--fix`

5. **Documentation & Testing**:
   - Updated `.claude/commands/cub:doctor.md` skill to use `--agent`
   - Added comprehensive tests (84 tests total for doctor functionality)
   - All 5084 project tests pass ✓
   - Type checking passes ✓
   - Linting passes ✓

### Example Output

```bash
$ cub doctor --agent
# cub doctor

System check complete. 7 checks passed.

## Results

| Category | Check | Status | Message |
|----------|-------|--------|----------|
| Environment | git | ✓ pass | git 2.46.0 |
| Environment | AI Harness | ✓ pass | AI harness found |
| Hooks | Hooks Installed | ✓ pass | Hooks installed |
...

## Analysis

- ✓ All systems operational
```

The refactored implementation maintains full backward compatibility while providing clean, structured output for LLM consumption when the `--agent` flag is used.