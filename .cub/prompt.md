# Project Prompt

This file provides context for AI coding agents working on this project.

## Overview


This feature replaces Cub's current shell-out harness implementation with a unified abstraction layer that supports multiple LLM providers (Claude, OpenAI, Gemini, local) while enabling provider-specific features like Claude Agent SDK hooks. The MVP is a full abstraction layer with all 4 providers, async-only API, and graceful degradation for missing features.

## Problem Statement

## Problem Statement


Cub is currently tightly coupled to Claude via shell-out. To support multi-model review, cost optimization, and provider-specific features (like hooks for circuit breakers), we need a harness abstraction that provides a common interface while allowing special capabilities when running Claude.

**Who has this problem:** Cub users who want to use multiple LLM providers, optimize costs by routing simple tasks to cheaper models, or leverage advanced features like circuit breakers via SDK hooks.

## Technical Approach


The harness abstraction evolves the current synchronous Protocol-based design to an async-first architecture that leverages the Claude Agent SDK for rich features (hooks, custom tools, streaming) while preserving shell-out harnesses as fallbacks.

The key insight is that the Claude Agent SDK is **async-only** and provides `query()` for simple usage and `ClaudeSDKClient` for stateful, hook-enabled sessions. We build a new `AsyncHarnessBackend` Protocol that mirrors these capabilities, with graceful degradation for harnesses that don't support all features.

The architecture maintains backward compatibility by:
1. Renaming current harnesses to `*-legacy` (e.g., `claude-legacy`)
2. Creating new SDK-based harnesses with the original names
3. Providing a migration path via `--harness claude-legacy`

## Architecture


```
┌─────────────────────────────────────────────────────────────────────┐
│                           cub run (async)                           │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    HarnessSelector                            │  │
│  │  - select_harness(task, requirements) -> AsyncHarnessBackend  │  │
│  │  - detect_harness(priority) -> str                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                │                                    │
│         ┌──────────────────────┼──────────────────────┐            │
│         ▼                      ▼                      ▼            │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐      │
│  │ ClaudeSDK   │       │ ShellOut    │       │ OpenAI      │      │
│  │ Harness     │       │ Harness     │       │ Harness     │      │
│  │             │       │             │       │ (future)    │      │
│  │ • hooks ✓   │       │ • hooks ✗   │       │ • hooks ✗   │      │
│  │ • tools ✓   │       │ • tools ✗   │       │ • tools ✗   │      │
│  │ • stream ✓  │       │ • stream ✓  │       │ • stream ✓  │      │

## Requirements

### P0 (Must Have)

- **Core Harness interface** - Abstract base class with `run_task()`, `stream_task()`, `supports_feature()` methods
- **Claude SDK harness** - Full implementation using Claude Agent SDK with hooks, custom tools, and complete feature set
- **OpenAI SDK harness** - SDK-based implementation with basic completion support
- **Generic shell-out harness** - Fallback for Gemini, local models, and any CLI

## Constraints


- Must use Claude Agent SDK for the Claude harness (primary constraint)
- Async-only API (no sync wrappers for backwards compatibility)
- Breaking changes acceptable (this is a major version change)
- `--harness claude-legacy` available during transition for users who need shell-out behavior

---

Generated by cub prep. Session artifacts in .cub/sessions/
