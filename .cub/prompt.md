# Project Prompt

This file provides context for AI coding agents working on this project.

## Overview

When tasks transition from "in progress" to "completed," critical information is lost:
- **What was the original intent?** (beads forgets to keep context small)
- **What approach did the agent take?** (not recorded)
- **How much did it cost?** (tokens extracted but not persisted)
- **What lessons were learned?** (scattered in progress.txt)

## Requirements

### P0 - Must Have

- **Token/cost persistence** - Store TokenUsage in task.json, aggregate in run.json, display in cub status
  - *Rationale: Enables all downstream cost analysis; currently extracted but not saved*

- **Ledger writer** - Create `.cub/ledger/by-task/{id}.md` entries on task close
  - *Rationale: The core missing piece between beads (in-progress) and git (permanent record)*

- **Ledger index** - Maintain `.cub/ledger/index.jsonl` for fast queries
  - *Rationale: Enables `cub ledger stats`, `cub ledger search` without parsing all markdown*

## Components

### 1. Enhanced Run Artifacts

**Purpose:** Persist token/cost data that's currently in-memory only during runs.

**Responsibilities:**
- Save `TokenUsage` to `task.json` after each harness invocation
- Aggregate totals in `run.json` at run completion
- Capture raw harness output to `harness.log`
- Save rendered prompts to `prompt.md`

**Dependencies:** Existing `HarnessResult`, `TaskResult`, `TokenUsage` models

**Interface:** Extensions to existing `StatusWriter` and run loop in `cli/run.py`

**Location:** Modifications to `src/cub/core/status/writer.py` and `src/cub/cli/run.py`

## Constraints

- **File-based storage preferred** - Per Letta research, simple filesystem approaches outperform complex systems (74% on LoCoMo benchmark)
- **Python preferred** - Must integrate with existing codebase; new languages acceptable if necessary
- **Breaking changes acceptable** - Does not need to be backward compatible with existing `.cub/` structure
- **Open to new dependencies** - If they are logical drop-ins, not opposed; but default to rolling our own

---

Generated by cub stage from plan: knowledge-retention-system
