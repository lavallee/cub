---
status: researching
priority: critical
complexity: high
dependencies: []
blocks: []
created: 2026-01-26
updated: 2026-01-26
readiness:
  score: 7
  blockers: []
  questions:
    - What's the exact sync branch workflow (commit frequency, merge strategy)?
    - How do we handle conflicts if tasks.jsonl is edited manually?
    - Should "both" mode be opt-in or default during transition period?
  decisions_needed:
    - Sync branch name convention (e.g., `cub-sync` vs `cub-tasks`)
  tools_needed: []
---

# 0.30 Foundation Phase: Task Backend Unification & Polish

## Overview

Consolidate cub's task management on a single, robust format by adopting beads' JSONL schema for the native backend. Implement a "both" mode for migration validation with comparison tooling, add a native sync-branch mechanism for git-based persistence, and bundle with documentation audit and CLI polish to create a solid foundation for 0.30 public alpha.

This spec combines the original E1-E3 epics into a cohesive foundation phase, with E1 significantly expanded from "flip the default" to "unify the backends properly."

## Goals

1. **Adopt beads JSONL format** as cub's native task format
   - Eliminate format divergence between backends
   - Use `.cub/tasks.jsonl` as the canonical location
   - Full schema adoption (issue_type, dependencies array, timestamps, etc.)

2. **Implement "both" mode** for migration validation
   - Dual read/write: every operation hits both beads and JSON backends
   - Beads remains source of truth during transition
   - Divergence detection that logs/warns but doesn't block progress
   - Comparison script in `./scripts/` for manual validation

3. **Implement native sync-branch mechanism**
   - Git-based persistence similar to beads' sync branch model
   - Dedicated branch (e.g., `cub-sync`) for task state
   - Python-native implementation (no `bd` dependency)

4. **Audit and fix documentation**
   - README reflects current commands and capabilities
   - Quick Start produces working output
   - Experimental features marked clearly
   - Alpha disclaimer prominent

5. **Polish CLI for consistency**
   - Helpful `--help` text on all commands
   - Actionable error messages
   - Consistent exit codes
   - `cub docs` command to open documentation

## Non-Goals

- Removing beads backend support (remains available for advanced users)
- Full beads feature parity (daemon, multi-repo, worktrees beyond sync)
- Speccing E4-E10 (deferred until after task cutover validated)
- Building a web UI for task management
- Supporting multiple simultaneous task files

## Design / Approach

### Component 1: JSONL Backend (replaces current JsonBackend)

**File location:** `.cub/tasks.jsonl`

**Schema adoption:** Match beads format exactly:

```json
{
  "id": "cub-001",
  "title": "Task title",
  "description": "Full description with markdown",
  "status": "open|in_progress|closed",
  "priority": 0-4,
  "issue_type": "task|feature|bug|epic|gate",
  "labels": ["label1", "label2"],
  "assignee": "username or null",
  "parent": "epic-id or null",
  "dependencies": [
    {"issue_id": "cub-001", "depends_on_id": "cub-000", "type": "blocks|parent-child", "created_at": "ISO8601"}
  ],
  "created_at": "ISO8601",
  "updated_at": "ISO8601",
  "closed_at": "ISO8601 or null",
  "close_reason": "string or null"
}
```

**Key changes from current `prd.json`:**
- JSONL format (one object per line) instead of JSON object with `tasks` array
- `issue_type` field instead of `type`
- `dependencies` array with full relationship objects instead of flat `depends_on` list
- `close_reason` field for closure context
- Remove `prefix` concept (IDs are self-contained)

**Implementation approach:**
1. Create new `JsonlBackend` class in `src/cub/core/tasks/jsonl.py`
2. Implement full `TaskBackend` protocol
3. Handle migration from old `prd.json` format on first access
4. Register as `"jsonl"` backend, eventually becomes default

### Component 2: Sync Branch Mechanism

**Concept:** Task state is committed to a dedicated git branch, keeping task history separate from code history while remaining git-native.

**Branch name:** `cub-sync` (configurable in `.cub/config.toml`)

**Workflow:**
1. On task mutation (create, update, close), write to `.cub/tasks.jsonl`
2. Commit change to `cub-sync` branch (using git plumbing, not checkout)
3. On read, optionally pull latest from remote `cub-sync` if available
4. Merge strategy: last-write-wins per task ID (JSONL makes this tractable)

**Implementation approach:**
1. Create `src/cub/core/tasks/sync.py` module
2. Use `git write-tree`, `git commit-tree`, `git update-ref` for branchless commits
3. Store sync state in `.cub/.sync-state.json` (last sync commit, etc.)
4. Add `cub sync` command for manual sync operations
5. Auto-sync on task mutations (configurable)

**Sync commands:**
- `cub sync` — Push local task changes to sync branch
- `cub sync --pull` — Pull remote task changes
- `cub sync --status` — Show sync state without syncing

### Component 3: "Both" Mode

**Purpose:** Validate that the new JSONL backend produces identical results to beads during transition.

**Behavior:**
- Every read operation queries both backends
- Every write operation updates both backends
- Divergence is logged to `.cub/backend-divergence.log`
- Beads is source of truth (if divergence, beads result is used)

**Configuration:**
```toml
# .cub/config.toml
[task_backend]
mode = "both"  # "beads", "jsonl", or "both"
```

**Comparison script:** `./scripts/compare-backends.py`
- Loads all tasks from both backends
- Reports differences (missing tasks, field mismatches, etc.)
- Exit code 0 if identical, 1 if divergent
- Human-readable diff output

### Component 4: Documentation Audit

**Scope:**
1. Run `cub --help` and compare against README
2. Remove references to deprecated commands (`cub prep`, old flags)
3. Walk through Quick Start end-to-end, fix gaps
4. Add alpha disclaimer banner to README
5. Add security warning section (permissions skipping)
6. Mark sandbox/toolsmith as `[EXPERIMENTAL]`
7. Review CONTRIBUTING.md against current architecture

**Deliverables:**
- Updated README.md
- Updated CONTRIBUTING.md
- New `docs/ALPHA-NOTES.md` with known limitations

### Component 5: CLI Polish

**Scope:**
1. Audit all command help text, improve where needed
2. Add actionable suggestions to common errors
3. Standardize exit codes (0=success, 1=error, 2=user error)
4. Implement `cub docs` command (opens docs in browser)
5. Add `Development Status :: 3 - Alpha` classifier to pyproject.toml
6. Test error scenarios (no harness, no git, etc.)

**Error message pattern:**
```
Error: No AI harness detected.

To fix this, install one of:
  - Claude Code: npm install -g @anthropic-ai/claude-code
  - Codex CLI: pip install openai

Then run: cub doctor
```

## Implementation Notes

### Migration Path

**For existing beads users (like this project):**
1. Enable "both" mode in config
2. Run comparison script to validate initial parity
3. Continue using cub normally; both backends stay in sync
4. Once confident, switch to `mode = "jsonl"`
5. Beads backend remains available for `--backend beads` override

**For existing prd.json users:**
1. `cub init` detects old format, offers migration
2. Migration creates `.cub/tasks.jsonl` from `prd.json`
3. Old `prd.json` renamed to `prd.json.bak`
4. New projects get JSONL by default

**For new users:**
1. `cub init` creates `.cub/tasks.jsonl` with JSONL format
2. No beads dependency required
3. Sync branch created automatically

### File Structure Changes

```
.cub/
├── config.toml          # Cub configuration
├── tasks.jsonl          # Task data (new canonical location)
├── .sync-state.json     # Sync branch state
├── backend-divergence.log  # "Both" mode divergence log
├── ledger/              # Existing ledger
└── runs/                # Existing run artifacts
```

### Estimated Effort

| Component | Effort | Notes |
|-----------|--------|-------|
| JSONL Backend | Medium (4-6h) | New backend class, format migration |
| Sync Branch | Medium-High (6-8h) | Git plumbing, state management |
| "Both" Mode | Medium (4-6h) | Wrapper backend, comparison logic |
| Comparison Script | Small (2h) | Python script in ./scripts |
| Documentation Audit | Medium (3-4h) | Manual review + updates |
| CLI Polish | Medium (4-6h) | Error messages, help text, `cub docs` |
| **Total** | **~25-35 hours** | Spread across multiple sessions |

### Testing Strategy

1. **Unit tests** for JSONL backend (format parsing, CRUD operations)
2. **Integration tests** for sync branch (git operations)
3. **Property tests** for "both" mode (beads ↔ JSONL parity)
4. **Manual testing** per the human testing plan in `public-alpha-0.30-plan.md`

## Open Questions

1. What's the exact sync branch workflow (commit frequency, merge strategy)?
2. How do we handle conflicts if `tasks.jsonl` is edited manually?
3. Should "both" mode be opt-in or default during transition period?

## Future Considerations

- **Multi-repo sync:** Beads supports hydrating from multiple repos; could add later
- **Daemon mode:** Background process for faster operations; not needed for alpha
- **Worktree isolation:** Full worktree support for sync; simpler approach first
- **Conflict resolution UI:** Interactive merge for task conflicts; manual for now

---

**Status**: researching
**Last Updated**: 2026-01-26
