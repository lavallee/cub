#!/usr/bin/env bash
#
# curb - Claude Under Ralph + Beads
#
# Autonomous AI coding agent harness that drives Claude Code in a loop
# to build software from a prd.json backlog with beads-style task tracking.
#
# Usage:
#   curb              # Run loop until all tasks complete
#   curb --once       # Run single iteration
#   curb --status     # Show current task status
#   curb --ready      # Show ready tasks
#   curb --plan       # Run in planning mode (generate fix_plan.md)
#   curb --budget 1000000  # Set token budget for run
#   curb --debug      # Enable debug logging (can combine with other flags)
#
set -euo pipefail

# Error trap for debugging - logs where script crashes due to set -e
_error_trap() {
    local exit_code=$?
    local line_no=$1
    echo "[ERROR] Script exited at line ${line_no} with exit code ${exit_code}" >&2
    # Also log to structured logger if available
    if type log_error &>/dev/null && [[ -n "$(logger_get_file 2>/dev/null)" ]]; then
        log_error "Script crashed" "{\"line\": ${line_no}, \"exit_code\": ${exit_code}}"
    fi
}
trap '_error_trap ${LINENO}' ERR

# Version information
CURB_VERSION="1.0.0"

CURB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="${CURB_PROJECT_DIR:-$(pwd)}"

# Source task management library
source "${CURB_DIR}/lib/tasks.sh"
# Source harness abstraction layer
source "${CURB_DIR}/lib/harness.sh"
# Source XDG directory helpers
source "${CURB_DIR}/lib/xdg.sh"
# Source configuration management
source "${CURB_DIR}/lib/config.sh"
# Source logger
source "${CURB_DIR}/lib/logger.sh"
# Source git operations
source "${CURB_DIR}/lib/git.sh"
# Source state verification
source "${CURB_DIR}/lib/state.sh"
# Source budget tracking
source "${CURB_DIR}/lib/budget.sh"
# Source hooks framework
source "${CURB_DIR}/lib/hooks.sh"
# Source session management
source "${CURB_DIR}/lib/session.sh"
# Source artifacts management
source "${CURB_DIR}/lib/artifacts.sh"
# Source failure handling
source "${CURB_DIR}/lib/failure.sh"
# Source project checks
source "${CURB_DIR}/lib/project.sh"
# Source command implementations
source "${CURB_DIR}/lib/cmd_init.sh"
source "${CURB_DIR}/lib/cmd_run.sh"
source "${CURB_DIR}/lib/cmd_status.sh"
source "${CURB_DIR}/lib/cmd_explain.sh"
source "${CURB_DIR}/lib/cmd_artifacts.sh"
source "${CURB_DIR}/lib/cmd_agent.sh"
source "${CURB_DIR}/lib/cmd_doctor.sh"

# Load configuration early
config_load

# Version subcommand
cmd_version() {
    echo "curb v${CURB_VERSION}"
    return 0
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Debug mode (set via --debug flag)
DEBUG="${CURB_DEBUG:-false}"
# Stream mode (set via --stream flag)
STREAM="${CURB_STREAM:-false}"
# Backend mode (set via --backend flag or CURB_BACKEND env)
# Values: "auto", "beads", "json"
BACKEND="${CURB_BACKEND:-auto}"
# Harness (set via --harness flag, HARNESS env, or config file)
# Values: "auto", "claude", "codex", "opencode", "gemini"
# Priority: CLI flag > env var > config harness.priority > default (claude > opencode > codex > gemini)
HARNESS="${HARNESS:-$(config_get_or "harness.default" "auto")}"
# Model (set via --model flag or CURB_MODEL env)
# Values: "opus", "sonnet", "haiku" (only applies to claude harness)
MODEL="${CURB_MODEL:-}"
# Epic filter (set via --epic flag or CURB_EPIC env)
EPIC="${CURB_EPIC:-}"
# Label filter (set via --label flag or CURB_LABEL env)
LABEL="${CURB_LABEL:-}"
# Budget (set via --budget flag, CURB_BUDGET env, or config file)
BUDGET="${CURB_BUDGET:-}"
# Require clean state (set via --require-clean flag or config)
# Empty means use config default, "true"/"false" overrides config
REQUIRE_CLEAN="${CURB_REQUIRE_CLEAN:-}"
# Session name (set via --name flag or CURB_SESSION_NAME env)
SESSION_NAME="${CURB_SESSION_NAME:-}"
# Push flag (set via --push flag)
# Values: "true" or "false"
PUSH="${CURB_PUSH:-false}"

log_info() { echo -e "${BLUE}[curb]${NC} $1"; }
log_success() { echo -e "${GREEN}[curb]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[curb]${NC} $1"; }
_log_error_console() { echo -e "${RED}[curb]${NC} $1" >&2; }
log_debug() {
    if [[ "$DEBUG" == "true" ]]; then
        echo -e "${DIM}${CYAN}[debug]${NC}${DIM} $1${NC}" >&2
    fi
}

# Deprecation warning helper
warn_deprecated_flag() {
    local old_flag="$1"
    local new_syntax="$2"

    # Check if deprecation warnings are suppressed
    if [[ "${CURB_NO_DEPRECATION_WARNINGS:-}" == "1" ]]; then
        return 0
    fi

    echo -e "${YELLOW}[curb]${NC} Warning: ${old_flag} is deprecated, use: ${new_syntax}" >&2
}

# Main entry point
main() {
    # Parse global flags (affect entire system) and separate run-specific flags
    local args=()
    for arg in "$@"; do
        if [[ "$arg" == "--debug" || "$arg" == "-d" ]]; then
            DEBUG="true"
            log_debug "Debug mode enabled"
            log_debug "CURB_DIR=${CURB_DIR}"
            log_debug "PROJECT_DIR=${PROJECT_DIR}"
            log_debug "Shell: $SHELL (bash ${BASH_VERSION})"
            log_debug "Date: $(date)"
        elif [[ "$arg" == "--stream" ]]; then
            STREAM="true"
            log_info "Stream mode enabled - showing harness activity"
        elif [[ "$arg" == "--backend="* ]]; then
            BACKEND="${arg#--backend=}"
            export CURB_BACKEND="$BACKEND"
        elif [[ "$arg" == "--backend" ]]; then
            # Next arg is the backend value - handle in next iteration
            _next_is_backend=true
            continue
        elif [[ "${_next_is_backend:-}" == "true" ]]; then
            BACKEND="$arg"
            export CURB_BACKEND="$BACKEND"
            _next_is_backend=false
        elif [[ "$arg" == "--harness="* ]]; then
            HARNESS="${arg#--harness=}"
            export HARNESS
        elif [[ "$arg" == "--harness" ]]; then
            # Next arg is the harness value - handle in next iteration
            _next_is_harness=true
            continue
        elif [[ "${_next_is_harness:-}" == "true" ]]; then
            HARNESS="$arg"
            export HARNESS
            _next_is_harness=false
        else
            # Pass all other args through (including run-specific flags)
            args+=("$arg")
        fi
    done
    unset _next_is_backend
    unset _next_is_harness

    check_deps
    log_debug "Dependencies checked: jq and harness found"

    # Subcommand dispatcher (check for subcommands before legacy flags)
    # Process first non-flag argument as potential subcommand
    local first_arg="${args[0]:-}"

    # Check if first arg is a subcommand (not a flag)
    if [[ -n "$first_arg" && ! "$first_arg" =~ ^- ]]; then
        case "$first_arg" in
            init)
                # Pass remaining args to cmd_init
                cmd_init "${args[@]:1}"
                return $?
                ;;
            run)
                # Run the main loop with remaining args
                cmd_run "${args[@]:1}"
                return $?
                ;;
            status)
                # Show task status
                cmd_status "${args[@]:1}"
                return $?
                ;;
            explain)
                # Explain a task or session
                cmd_explain "${args[@]:1}"
                return $?
                ;;
            artifacts)
                # Manage artifacts
                cmd_artifacts "${args[@]:1}"
                return $?
                ;;
            agent-close)
                # Close a task (agent helper command)
                cmd_agent_close "${args[@]:1}"
                return $?
                ;;
            agent-verify)
                # Verify a task is closed (agent helper command)
                cmd_agent_verify "${args[@]:1}"
                return $?
                ;;
            doctor)
                # Diagnose and fix common issues
                cmd_doctor "${args[@]:1}"
                return $?
                ;;
            version)
                # Show version
                cmd_version
                return $?
                ;;
            help)
                # Show help (fall through to --help handling below)
                args=("--help")
                ;;
            *)
                # Unknown subcommand - show error and help
                # (only show error for non-flag arguments)
                if [[ ! "$first_arg" =~ ^- ]]; then
                    _log_error_console "Unknown subcommand: ${first_arg}"
                    echo ""
                    args=("--help")
                fi
                ;;
        esac
    fi

    # Legacy flag parsing (for backwards compatibility)
    case "${args[0]:-}" in
        --status|-s)
            warn_deprecated_flag "--status" "curb status"
            cmd_status "${args[@]:1}"
            ;;
        --ready|-r)
            warn_deprecated_flag "--ready" "curb run --ready"
            cmd_run --ready "${args[@]:1}"
            ;;
        --once|-1)
            warn_deprecated_flag "--once" "curb run --once"
            cmd_run --once "${args[@]:1}"
            ;;
        --plan|-p)
            warn_deprecated_flag "--plan" "curb run --plan"
            cmd_run --plan "${args[@]:1}"
            ;;
        --test|-t)
            log_info "Testing Claude Code invocation..."
            log_debug "Binary: $(which claude)"
            log_debug "Version: $(claude --version 2>&1)"
            echo ""
            log_info "Test 1: Simple echo pipe"
            log_debug "Command: echo 'Say hello' | claude -p"
            if echo "Say hello" | claude -p; then
                log_success "Test 1 passed"
            else
                _log_error_console "Test 1 failed (exit: $?)"
            fi
            echo ""
            log_info "Test 2: Heredoc pipe"
            log_debug "Command: claude -p <<< 'Say goodbye'"
            if claude -p <<< "Say goodbye"; then
                log_success "Test 2 passed"
            else
                _log_error_console "Test 2 failed (exit: $?)"
            fi
            echo ""
            log_info "Test 3: Multi-line prompt"
            local test_prompt="You are a helpful assistant.

Say 'curb test successful' and nothing else."
            log_debug "Command: echo \"\$test_prompt\" | claude -p"
            if echo "$test_prompt" | claude -p; then
                log_success "Test 3 passed"
            else
                _log_error_console "Test 3 failed (exit: $?)"
            fi
            echo ""
            log_success "All tests complete"
            ;;
        --migrate-to-beads)
            if [[ ! -f "${PROJECT_DIR}/prd.json" ]]; then
                _log_error_console "No prd.json found to migrate"
                exit 1
            fi
            log_info "Migrating from prd.json to beads..."
            echo ""
            migrate_json_to_beads "${PROJECT_DIR}/prd.json" "false"
            ;;
        --migrate-to-beads-dry-run)
            if [[ ! -f "${PROJECT_DIR}/prd.json" ]]; then
                _log_error_console "No prd.json found to migrate"
                exit 1
            fi
            log_info "DRY RUN: Showing what would be migrated..."
            echo ""
            migrate_json_to_beads "${PROJECT_DIR}/prd.json" "true"
            ;;
        --dump-prompt)
            validate_project
            local prd="${PROJECT_DIR}/prd.json"
            local current_task
            current_task=$(get_in_progress_task "$prd")
            if [[ -z "$current_task" || "$current_task" == "null" ]]; then
                current_task=$(get_ready_tasks "$prd" | jq 'first')
            fi
            if [[ "$current_task" == "null" || -z "$current_task" ]]; then
                _log_error_console "No tasks available"
                exit 1
            fi
            local sys_file="${PROJECT_DIR}/curb_system_prompt.txt"
            local task_file="${PROJECT_DIR}/curb_task_prompt.txt"
            generate_system_prompt > "$sys_file"
            generate_task_prompt "$current_task" > "$task_file"
            log_success "Prompts dumped:"
            log_info "  System: ${sys_file} ($(wc -c < "$sys_file") bytes)"
            log_info "  Task:   ${task_file} ($(wc -c < "$task_file") bytes)"
            log_info ""
            log_info "To test manually:"
            log_info "  claude -p --append-system-prompt \"\$(cat ${sys_file})\" < ${task_file}"
            ;;
        --help|-h)
            cat <<EOF
curb v${CURB_VERSION} - Claude Under Ralph + Beads

Autonomous AI coding agent that drives harnesses in a loop to complete
tasks from a project backlog.

SUBCOMMANDS:
  curb init [--global] [<dir>]  Initialize project or system
  curb run [<options>]           Run the main loop (default)
  curb status [--json]           Show task progress
  curb explain <task-id>         Show task details
  curb artifacts [<task-id>]     List task outputs
  curb agent-close <task-id>     Close a task (for agent use)
  curb agent-verify <task-id>    Verify task is closed
  curb doctor [--fix]            Diagnose and fix issues
  curb version                   Show version

QUICK START:
  curb init                      Initialize in current directory
  curb run                       Start the main loop
  curb status                    Check progress
  curb run --ready               List tasks to work on

USE --help WITH ANY SUBCOMMAND:
  curb init --help               Init subcommand help
  curb run --help                Run subcommand help
  curb status --help             Status subcommand help
  curb explain --help            Explain subcommand help
  curb artifacts --help          Artifacts subcommand help

EXECUTION MODES:
  curb                           Run continuous loop
  curb run --once                Single iteration then exit
  curb run --ready               List ready tasks
  curb run --plan                Analyze code and plan

CORE FLAGS (work with run):
  --harness <name>               Use specific harness (auto, claude, codex,
                                 gemini, opencode)
  --model <name>                 Claude model (opus, sonnet, haiku)
  --budget <tokens>              Set token budget (e.g., 1000000)
  --name <name>                  Session name for tracking

FILTERING:
  --epic <id>                    Work on tasks in epic
  --label <name>                 Work on tasks with label

RELIABILITY:
  --require-clean                Enforce clean git state
  --no-require-clean             Disable clean state check

DEBUGGING:
  --debug, -d                    Show detailed logs
  --stream                       Stream harness output
  --backend <mode>               Task backend (auto, beads, json)

UTILITY:
  --test                         Test harness invocation
  --dump-prompt                  Export task prompts
  --migrate-to-beads             Convert prd.json to beads
  --migrate-to-beads-dry-run     Preview migration

EXAMPLES:
  curb                           Start main loop
  curb run --once                Single iteration
  curb status                    Show progress
  curb run --ready               List tasks
  curb run --epic backend-v2     Work on epic
  curb run --once --debug        Debug one iteration
  curb run --model sonnet        Use Sonnet model
  curb artifacts curb-018        Get task output
  curb explain curb-018          See task details
  curb init ~/my-project         Initialize project
  curb init --global             Setup system config

ENVIRONMENT VARIABLES:
  CURB_PROJECT_DIR               Project directory (default: pwd)
  CURB_MAX_ITERATIONS            Max loop iterations (default: 100)
  CURB_DEBUG                     Set to "true" for debug
  CURB_BACKEND                   Task backend (auto/beads/json)
  CURB_BUDGET                    Token budget
  CURB_REQUIRE_CLEAN             Clean state enforcement
  HARNESS                        Harness to use
  CURB_MODEL                     Claude model
  CURB_EPIC                      Epic filter
  CURB_LABEL                     Label filter

PROJECT FILES:
  prd.json                       Task backlog (json backend)
  .beads/                        Task tracking (beads backend)
  PROMPT.md                      System prompt template
  AGENT.md                       Build/run instructions
  specs/                         Specification files
  progress.txt                   Progress log
  fix_plan.md                    Issue tracking

LEARN MORE:
  README.md                      Overview and features
  CONFIG.md                      Configuration options
  CONTRIBUTING.md                Development guidelines

INSTALLATION:
  Beads (optional):
    brew install steveyegge/beads/bd
    npm install -g @beads/bd
    go install github.com/steveyegge/beads/cmd/bd@latest
EOF
            ;;
        --version)
            echo "curb v${CURB_VERSION}"
            ;;
        *)
            # Default: run the main loop with all args
            cmd_run "${args[@]}"
            ;;
    esac
}

main "$@"
