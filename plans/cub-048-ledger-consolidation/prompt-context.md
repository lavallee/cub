# Plan Context: cub-048-ledger-consolidation

This file contains plan-specific context extracted from planning artifacts.
It is injected into harness sessions at runtime.

## Problem Statement

**Who has this problem:** Developers using cub for autonomous coding sessions.

**The problem:**
- Redundant storage locations make it unclear where artifacts live
- Random-suffix IDs (e.g., `cub-a1f`) can collide across parallel worktrees

## Requirements

### P0 - Must Have

| # | Requirement | Rationale |
|---|-------------|-----------|
| 1 | **Hierarchical ID System** | Enable traceability: spec(number) → plan(spec+letter) → epic(plan+char) → task(epic.number) |
| 2 | **Counter Tracking on Sync Branch** | `.cub/counters.json` with pre-push hook for collision detection/resolution |
| 3 | **Unified Ledger Structure** | Single `ledger/` with `by-task/`, `by-epic/`, `by-plan/`, `by-run/` subdirectories |
| 4 | **Eliminate Redundant Storage** | Remove `runs/`, `run-sessions/`, `logs/` directories |
| 5 | **JSONL Harness Logs** | Convert harness logs from plaintext to JSONL for structured queries |
| 6 | **`cub run --plan`** | Collapse `build-plan` into run command; remove `build-plan` entirely |

## Components

### ID System (`core/ids/`)

- **Purpose:** Generate and validate hierarchical IDs with counter-based allocation
- **Responsibilities:**
  - Generate spec, plan, epic, task, and standalone IDs
  - Parse and validate ID strings
  - Allocate counters from sync branch
  - Detect collisions via pre-push hook
- **Dependencies:** `core/sync/` for counter storage
- **Interface:** `generate_spec_id()`, `generate_plan_id()`, `generate_epic_id()`, `generate_task_id()`, `parse_id()`, `validate_id()`

**Package Structure:**
```
core/ids/
├── __init__.py       # Public API exports

## Constraints

| Constraint | Impact |
|------------|--------|
| Extend existing hooks infrastructure | New lifecycle hooks must follow established patterns in `.cub/hooks/` |
| Sync branch mechanism required | Counter allocation depends on sync branch being available |
| JSONL as canonical format | All structured data uses JSONL for consistency with task backend |

---

Generated by `cub stage` from plan: cub-048-ledger-consolidation