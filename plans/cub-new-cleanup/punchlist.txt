# cub new Cleanup

Issues identified during `cub new` testing.

---

Statusline only reads from beads backend

The statusline script at `templates/scripts/statusline.py` line 35 hardcodes reading task counts from `.beads/issues.jsonl`. It completely ignores the JSONL backend at `.cub/tasks.jsonl`. This means statusline shows 0/0/0 task counts for any project using the JSONL backend.

Fix: Update statusline.py to check both `.beads/issues.jsonl` AND `.cub/tasks.jsonl`, using the same detection logic as `get_backend()` in the tasks module.

Files: src/cub/templates/scripts/statusline.py

---

Project ID prefix uses directory name, causes collisions

The `_get_prefix()` method in `jsonl.py` takes the first 3 characters of the project directory name as the task ID prefix. This means a project in `/projects/cub-roundabout/` gets prefix "cub", same as the cub project itself. The roundabout project ended up with task IDs like `cub-a1x` instead of `rou-a1x`.

Fix: Add explicit `project_id` or `prefix` setting to `.cub/config.json`. Have `cub init` prompt for or auto-generate a unique prefix. Use this prefix for all task/epic IDs instead of inferring from directory name.

Files: src/cub/core/tasks/jsonl.py, src/cub/cli/init_cmd.py, src/cub/templates/.cub.json

---

Consolidate AGENTS.md and CLAUDE.md into single source

Currently `cub init` generates both AGENTS.md and CLAUDE.md as separate files with similar content. They should be the same file (symlinks or single source) to avoid drift and confusion.

Fix: Generate one canonical file (CLAUDE.md) and create AGENTS.md as a symlink, or generate both from identical template content. Update init_cmd.py accordingly.

Files: src/cub/cli/init_cmd.py, src/cub/core/instructions.py

---

Clarify prompt.md vs runloop.md purpose and consolidate

There are two similar files created during init:
- `.cub/runloop.md` - minimal core loop instructions (57 lines)
- `.cub/prompt.md` - full template with customization guidance (150+ lines)

The purpose and difference between these is unclear. Both seem to serve as "system prompt for autonomous runs".

Fix: Either consolidate into single file, or clearly document: runloop.md = system-managed core loop, prompt.md = user-customizable additions. Consider renaming to make purpose obvious.

Files: src/cub/cli/init_cmd.py, src/cub/templates/runloop.md, src/cub/templates/PROMPT.md

---

Consolidate config file locations

There are two config files with unclear separation of concerns:
- `.cub.json` in project root - user settings (harness, budget, state checks)
- `.cub/config.json` - internal state (dev_mode, etc.)

This is confusing for users. Should be consolidated or clearly documented.

Fix: Move all user-facing config to `.cub/config.json` and deprecate `.cub.json`, OR clearly document that `.cub.json` is user-editable and `.cub/config.json` is internal state only.

Files: src/cub/cli/init_cmd.py, src/cub/core/config/loader.py, src/cub/templates/.cub.json

---

Enhance agent.md template with richer cub workflow documentation

The `templates/agent.md` that becomes AGENTS.md/CLAUDE.md is functional but minimal. It should include more comprehensive guidance on using cub effectively.

Add: Quick start workflow, common command patterns, troubleshooting tips, how to read task output, hook log locations (.cub/ledger/forensics/), link to full docs.

Files: src/cub/templates/agent.md

---

Add constitution.md depth and customization guidance

The constitution.md template is sparse. Should include more detailed principles, examples of good/bad patterns, and guidance on how to customize for project-specific values.

Files: src/cub/templates/constitution.md

---

Create cub:stage skill

The `cub stage` command exists but there's no corresponding skill in `templates/commands/`. Need to create `cub:stage.md` skill so it appears in the skill list and can be invoked via `/stage`.

Files: src/cub/templates/commands/cub:stage.md

---

Document hook log location

Hooks write session forensics to `.cub/ledger/forensics/{session_id}.jsonl` but this isn't documented anywhere users would find it. Add documentation to agent.md template and consider adding `cub hooks log` command to view recent activity.

Files: src/cub/templates/agent.md, potentially src/cub/cli/hooks.py

---

Fix plan.json generation in planning workflow

The planning commands (`cub plan orient`, `cub plan architect`, `cub plan itemize`) don't properly generate and update plan.json through the pipeline. Need to audit each phase and ensure plan.json is created, updated, and readable by `cub stage`.

Files: src/cub/cli/plan.py, src/cub/core/plan/

---

Set explicit backend in cub init instead of auto-detection

Backend auto-detection checks for `.beads/` directory before `.cub/tasks.jsonl`, which can cause unexpected beads usage. `cub init` should set an explicit `backend.mode` in config rather than relying on auto-detection.

Fix: Have `cub init` write `"backend": {"mode": "jsonl"}` to config by default, or prompt user for backend choice.

Files: src/cub/cli/init_cmd.py

---

Don't overwrite user-modified prompt.md on init

If prompt.md is meant to be user-customizable, `cub init` should not overwrite it if it already exists and has been modified. Currently it may overwrite user customizations.

Fix: Check if prompt.md exists and differs from template before overwriting. Either skip or prompt user.

Files: src/cub/cli/init_cmd.py
